package com.fatwire.cs.rest.util;

import java.io.File;
import java.io.IOException;

import junit.framework.TestCase;

import org.apache.commons.io.FileUtils;

public class Base64Test extends TestCase {
    static final String x = "PCVAIHRhZ2xpYiBwcmVmaXg9ImNzIiB1cmk9ImZ1dHVyZXRlbnNlX2NzL2Z0Y3MxXzAudGxkIg0KICAgICAgICAlPjwlQCB0YWdsaWIgcHJlZml4PSJpY3MiIHVyaT0iZnV0dXJldGVuc2VfY3MvaWNzLnRsZCINCiAgICAgICAgJT48JUAgdGFnbGliIHByZWZpeD0icmVuZGVyIiB1cmk9ImZ1dHVyZXRlbnNlX2NzL3JlbmRlci50bGQiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJDT00uRnV0dXJlVGVuc2UuSW50ZXJmYWNlcy4qLA0KICAgICAgICAgICAgICAgICAgIENPTS5GdXR1cmVUZW5zZS5VdGlsLmZ0TWVzc2FnZSwNCiAgICAgICAgICAgICAgICAgICBDT00uRnV0dXJlVGVuc2UuVXRpbC5mdEVycm9ycyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sYW5nLlN0cmluZ1V0aWxzIg0KICAgICAgICAlPjwlQCBwYWdlIGltcG9ydD0ib3JnLmFwYWNoZS5jb21tb25zLmlvLkZpbGVVdGlscyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sb2dnaW5nLkxvZyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sb2dnaW5nLkxvZ0ZhY3RvcnkiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJqYXZhLmlvLkZpbGUiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJDT00uRnV0dXJlVGVuc2UuVXRpbC5JdGVyYWJsZUlMaXN0V3JhcHBlciINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5BcnJheXMiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5hc3NldGFwaS5kYXRhLkFzc2V0RGF0YSINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5MaXN0Ig0KICAgICAgICAlPjwlQCBwYWdlIGltcG9ydD0iamF2YS5pby5JT0V4Y2VwdGlvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmNvbW1vbi5Bc3NldEFjY2Vzc0V4Y2VwdGlvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmRhdGEuQXNzZXRJZCINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5vcGVubWFya2V0LnhjZWxlcmF0ZS5hc3NldC5Bc3NldElkSW1wbCINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5BcnJheUxpc3QiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5hc3NldGFwaS5kYXRhLkFzc2V0RGF0YU1hbmFnZXIiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5zeXN0ZW0uU2Vzc2lvbkZhY3RvcnkiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5zeXN0ZW0uU2Vzc2lvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmRhdGEuTXV0YWJsZUFzc2V0RGF0YSINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5FbnVtZXJhdGlvbiINCiAgICAgICAgJT48Y3M6ZnRjcz48JS0tIEdVL2NvbW1vbi9Nb2R1bGVEaXNwYXRjaGVyDQoNCiAgICBXcml0ZW4gQnk6IFBlZHJhbSBCYWdoZXJpbmlhDQoNCglEYXRlOiA0LzIyLzA5DQoNCg0KCVB1cnBvc2U6IExvYWRzIHRoZSBtb2R1bGUgYW5kIGRldGVybWluZXMgdGhlIHJlcXVpcmVkIGNhbGxpbmcgYXJndW1lbnRzIGFuZCBkZXRlcm1pbmVzIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGFzc29jaWF0ZWQgdG8gdGhlIG1vZHVsZSBhbmQNCgkgICAgICAgICBjYWxscyBpdC4gVGhpcyBlbGVtZW50IGlzIGNhbGxlZCBieSBNb2R1bGVsaXN0IHRlbXBsYXRlIGFuZCBMYXlvdXRSZW5kZXJlciB3aXRoIHNjb3BlIGdsb2JhbC4NCg0KSU5QVVQNCiAgICBtb2R1bGVfaWQgIC0gbW9kdWxlIGFzc2V0IGlkDQogICAgb3duZXJfaWQgIC0gY2FsbGluZyBhc3NldCBpZA0KICAgIG93bmVyX3R5cGUgIC0gY2FsbGluZyBhc3NldCB0eXBlDQpPVVRQVVQNCg0KLS0lPjwlDQolPjxpY3M6aWYgY29uZGl0aW9uPSc8JT1pY3MuR2V0VmFyKCJlaWQiKSE9bnVsbCU+Jz48JQ0KJT48aWNzOnRoZW4+PCUNCiU+PHJlbmRlcjpsb2dkZXAgY2lkPSc8JT1pY3MuR2V0VmFyKCJlaWQiKSU+JyBjPSJDU0VsZW1lbnQiLz48JQ0KJT48L2ljczp0aGVuPjwvaWNzOmlmPjwlDQoNCmxvZy5pbmZvKCJDYWxsZWQgd2l0aCBvd25lcjogIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsiIG93bmVyOiAiICArIGljcy5HZXRWYXIoIm93bmVyX2lkIikgKyIgIiAgKyBpY3MuR2V0VmFyKCJvd25lcl90eXBlIikpOw0KDQogICAgaWYoaWNzLkdldFZhcigicGFnZW5hbWUiKSA9PSBudWxsKXsNCiAgICAgICAgbG9nLndhcm4oInBhZ2VuYW1lIGlzIG51bGwiLCBuZXcgRXhjZXB0aW9uKCkpOw0KICAgIH0NCiAgICAvL0xvYWQgYWxsIHRoZSBtb2R1bGVzIGF0dHJpYnV0ZXMNCiU+PHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1UvY29tbW9uL0dldEFsbEF0dHJpYnV0ZXMiIHNjb3BlZD0iZ2xvYmFsIj48JQ0KJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9Imxvb2t1cF9pZCIgdmFsdWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICU+Jy8+PCUNCiU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJsb29rdXBfdHlwZSIgdmFsdWU9IkdVX01vZHVsZV9DIi8+PCUNCiU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwcmVmaXgiIHZhbHVlPSI8JT1pY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSAlPiIvPjwlDQolPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0iZGVidWciIHZhbHVlPSJubyIgLz48JQ0KJT48L3JlbmRlcjpjYWxsZWxlbWVudD48JQ0KDQogICAgLy9hcyBhIHJlcXVpcmVkIG1vZHVsZSBhdHRyaWJ1dGUgaWYgaXRzIHJlcXVpcmVkIGJ5IHRoaXMgbW9kdWxlLg0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoaWNzLkdldFZhcigib3duZXJfaWQiKSkpDQogICAgew0KICAgICAgICBpY3MuU2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjpvd25lcl9pZCIsaWNzLkdldFZhcigib3duZXJfaWQiKSk7DQogICAgICAgIGljcy5TZXRWYXIoaWNzLkdldFZhcigib3duZXJfaWQiKSsiOm93bmVyX3R5cGUiLGljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSk7DQogICAgICAgICU+PHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1UvY29tbW9uL0dldEFsbEF0dHJpYnV0ZXMiIHNjb3BlZD0iZ2xvYmFsIj48JQ0KICAgICAgICAgICAlPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9va3VwX2lkIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigib3duZXJfaWQiKSAlPicvPjwlDQogICAgICAgICAgICU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJsb29rdXBfdHlwZSIgdmFsdWU9IjwlPWljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSAlPiIvPjwlDQogICAgICAgICAgICU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwcmVmaXgiIHZhbHVlPSI8JT1pY3MuR2V0VmFyKCJvd25lcl9pZCIpICU+Ii8+PCUNCiAgICAgICAgICAgJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9ImRlYnVnIiB2YWx1ZT0ibm8iIC8+PCUNCiAgICAgICAgICU+PC9yZW5kZXI6Y2FsbGVsZW1lbnQ+PCUNCiAgICB9DQovL0lmIHBhZ2luYXRpb24gZXhpc3Qgd2UgbmVlZCBmb3JtYXQgaXQgc28gaXQgY2FuIGJlIHBpY2tlZCB1cCBhcyByZXF1aXJlZCBhdHRyaWJ1dGUNCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoInBhZ2UiKSkpDQogICAgew0KICAgICAgICBpY3MuU2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjpwYWdlIixpY3MuR2V0VmFyKCJwYWdlIikpOw0KDQogICAgfQ0KDQogICAgU3RyaW5nIHBhcmVudEF0dHJpYnV0ZXM9IiI7DQogICAgU3RyaW5nW10gcGFyZW50X2NhdGVnb3JpZXMgPW5ldyBTdHJpbmdbMF07DQoNCg0KLy9HZXQgbGlzdCBvZiBjYXRlZ29yeSBwYXJlbnQgYXR0cmlidXRlIHdlIG5lZWQuDQovL1RoaXMgaXMgcHJpbWFybHkgdXNlZCBieSB0aGUgcHVzaHB1bGwgbGlzdCB0byByZXN0cmljdCBjaGlsZHJlbiB0byBzcGVjaWZpYyBwYXJlbnRzIHdpdGgNCi8vYSBjYXRlZ29yeSBjb250cmFpbnMuDQogICAgaWYoaWNzLkdldExpc3QoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpwYXJlbnRmaWx0ZXJfYXJncyIpIT1udWxsICYmIGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiKS5oYXNEYXRhKCkpDQogICAgew0KCQklPjxpY3M6bGlzdGxvb3AgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiICU+Jz48JQ0KCQklPjxpY3M6bGlzdGdldCBmaWVsZG5hbWU9InZhbHVlIiBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpwYXJlbnRmaWx0ZXJfYXJncyIgJT4nIG91dHB1dD0iY2F0ZWdvcnlfYXJnIi8+PCUNCiAgICBpZihTdHJpbmdVdGlscy5pc0JsYW5rKHBhcmVudEF0dHJpYnV0ZXMpKQ0KICAgIHsNCiAgICAgICAgcGFyZW50QXR0cmlidXRlcyA9IGljcy5HZXRWYXIoImNhdGVnb3J5X2FyZyIpOw0KICAgIH0NCiAgICBlbHNlDQogICAgew0KICAgICAgICBwYXJlbnRBdHRyaWJ1dGVzID0gcGFyZW50QXR0cmlidXRlcysiLCIraWNzLkdldFZhcigiY2F0ZWdvcnlfYXJnIik7DQogICAgfQ0KJT48L2ljczpsaXN0bG9vcD48JQ0KICAgIH0NCiAgICBsb2cuaW5mbygicGFyZW50QXR0cmlidXRlczogIisgcGFyZW50QXR0cmlidXRlcyArIiwgbGlzdCBwYXJlbnRmaWx0ZXJfYXJncyBpcyBudWxsPSIrKGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiKT09bnVsbCkpOw0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsocGFyZW50QXR0cmlidXRlcykpDQogICAgLy9XZSB3YW50IHRvIGdldCB0aGUgZ2V0IGNhdGVnb3J5IGluZm9ybWF0aW9uIGZyb20gdGhlIG93bmVyIGFzc2V0IHNvIHdlIGxvYWQgdGhlIGFzc2V0cw0KICAgIC8vYXR0cmlidXRlcyBhZ2FpbiBidXQgdGhpcyB0aW1lIHdlIHNwZWNpZnkgdGhlIGluaGVydGVkIGF0dHJpYnV0ZXMgd2UgbmVlZC4NCiAgICB7DQogICAgICAgIGljcy5SZW1vdmVWYXIoInByZWZpeCIpOw0KCQklPjxyZW5kZXI6Y2FsbGVsZW1lbnQgZWxlbWVudG5hbWU9IkdVL2NvbW1vbi9HZXRBbGxBdHRyaWJ1dGVzIiBzY29wZWQ9Imdsb2JhbCI+PCUNCgkJJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9Imxvb2t1cF9pZCIgdmFsdWU9JzwlPWljcy5HZXRWYXIoIm93bmVyX2lkIikgJT4nLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9va3VwX3R5cGUiIHZhbHVlPSc8JT1pY3MuR2V0VmFyKCJvd25lcl90eXBlIikgJT4nLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0icHJlZml4IiB2YWx1ZT0iPCU9aWNzLkdldFZhcigib3duZXJfaWQiKSAlPiIvPjwlDQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwYXJlbnRfYXR0cmlidXRlcyIgdmFsdWU9IjwlPXBhcmVudEF0dHJpYnV0ZXMgJT4iLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0iZGVidWciIHZhbHVlPSJubyIgLz48JQ0KCQklPjwvcmVuZGVyOmNhbGxlbGVtZW50PjwlDQoNCiAgICAgICAgLy9CdWlsZCB0aGUgdmFsdWUgc3RyaW5nIG9mIHRoZSBjYXRlZ29yaWVzIHdlIHdhbnQgaWUgZ2VuZXJhbF9jYXRlZ29yeT0iMTk5OSxuZXdzIg0KICAgICAgICBwYXJlbnRfY2F0ZWdvcmllcyA9IFN0cmluZ1V0aWxzLnNwbGl0KHBhcmVudEF0dHJpYnV0ZXMsIiwiKTsNCg0KICAgICAgICBmb3IoU3RyaW5nIHBhcmVudF9jYXRlZ29yeSA6IHBhcmVudF9jYXRlZ29yaWVzKQ0KICAgICAgICB7DQogICAgICAgICAgICBJTGlzdCBjdXJyZW50X2NhdGVnb3J5X2xpc3QgPSBpY3MuR2V0TGlzdChpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitwYXJlbnRfY2F0ZWdvcnkpOw0KICAgICAgICAgICAgU3RyaW5nIGN1cnJlbnRfdmFsdWU9IiI7DQogICAgICAgICAgICBpZihudWxsICE9IGN1cnJlbnRfY2F0ZWdvcnlfbGlzdCAmJiBjdXJyZW50X2NhdGVnb3J5X2xpc3QuaGFzRGF0YSgpKXsNCiAgICAgICAgICAgICAgICBmb3IgKElMaXN0IHJvdyA6IG5ldyBJdGVyYWJsZUlMaXN0V3JhcHBlciggY3VycmVudF9jYXRlZ29yeV9saXN0KSl7DQogICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzQmxhbmsoY3VycmVudF92YWx1ZSkpDQogICAgICAgICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdmFsdWU9cm93LmdldFZhbHVlKCJ2YWx1ZSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2UNCiAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF92YWx1ZT1jdXJyZW50X3ZhbHVlKyIsIityb3cuZ2V0VmFsdWUoInZhbHVlIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoY3VycmVudF92YWx1ZSkpDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgaWNzLlNldFZhcihwYXJlbnRfY2F0ZWdvcnksY3VycmVudF92YWx1ZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgIH0NCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpmaWx0ZXJfYXNzZXRfdGVtcGxhdGUiKSkpew0KICAgICAgICBTdHJpbmcgdGVtcGxhdGVfbmFtZSA9IGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpmaWx0ZXJfYXNzZXRfdGVtcGxhdGUiKTsNCiAgICAgICAgU3RyaW5nIGVsZW1lbnRfdHlwZSA9IGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfc3R5bGUiKTsNCiAgICAgICAgbG9nLmRlYnVnKCJNb2R1bGUgIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIiB3aXRoIG93bmVyaWQ9ICIgKyBpY3MuR2V0VmFyKCJvd25lcl9pZCIpICsgIiByZW5kZXJtb2RlOiAiICsgaWNzLkdldFZhcigicmVuZGVybW9kZSIpICsgIiBzc2k9ICIgKyBpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6c3RhdGljX1NTSSIpKTsNCiAgICAgICAgLy9pZiB0aGUgbW9kdWxlIGlzIGNvbmZpZ3VyZWQgYXMgU1NJIGFuZCByZW5kZXJtb2RlIHN0YXJ0cyB3aXRoIGV4cG9ydCA9IHN0YXRpYyBwdWIsIHRoZW4NCiAgICAgICAgLy8gcHJvY2VzcyB0aGUgbW9kdWxlIGFzIGFuIFNTSQ0KICAgICAgICBpZigiWWVzIi5lcXVhbHNJZ25vcmVDYXNlKGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpzdGF0aWNfU1NJIikpICYmIChTdHJpbmdVdGlscy5zdGFydHNXaXRoKGljcy5HZXRWYXIoInJlbmRlcm1vZGUiKSwgImV4cG9ydCIpIHx8IFN0cmluZ1V0aWxzLnN0YXJ0c1dpdGgoaWNzLkdldFZhcigicmVuZGVybW9kZSIpLCAiZGVwcyIpKSl7DQogICAgICAgICAgICAvKmlmKCJZZXMiLmVxdWFsc0lnbm9yZUNhc2UoaWNzLkdldFZhcihpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSsiOnN0YXRpY19TU0kiKSkpew0KICAgICAgICAgICAgKi8gIGxvZy5kZWJ1ZygiTW9kdWxlICIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICIgaXMgYSBTU0kgd2l0aCBvd25lcmlkPSAiICsgaWNzLkdldFZhcigib3duZXJfaWQiKSk7DQogICAgICAgICAgICBpZighU3RyaW5nVXRpbHMuc3RhcnRzV2l0aChpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIiksICJkZXBzIikpew0KICAgICAgICAgICAgICAgIFN0cmluZ0J1ZmZlciBsaW5rVVJMYnVmZmVyID0gbmV3IFN0cmluZ0J1ZmZlcigpOw0KICAgICAgICAgICAgICAgIGxpbmtVUkxidWZmZXIuYXBwZW5kKGNhbGN1bGF0ZUluY2x1ZGVQYXRoUHJlZml4KGljcykpOw0KICAgICAgICAgICAgICAgIGxpbmtVUkxidWZmZXIuYXBwZW5kKCJpbmNsdWRlcy9tb2R1bGVzLyIraWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgIC8vcmVhZCB0aGUgbW9kdWxlIG91dHB1dCBpbnRvIGEgU3RyaW5nICh0aGVQYWdlKQ0KICAgICAgICAgICAgICAgIEZUVmFsTGlzdCBhcmdzID0gbmV3IEZUVmFsTGlzdCgpOw0KICAgICAgICAgICAgICAgIGFyZ3MucmVtb3ZlQWxsKCk7DQogICAgICAgICAgICAgICAgU3RyaW5nIG91dHB1dCA9IG51bGw7DQogICAgICAgICAgICAgICAgRW51bWVyYXRpb24gZW4gPSBpY3MuR2V0VmFycygpOw0KICAgICAgICAgICAgICAgIHdoaWxlIChlbi5oYXNNb3JlRWxlbWVudHMoKSkNCiAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgIFN0cmluZyB2YXJuYW1lID0gKFN0cmluZyllbi5uZXh0RWxlbWVudCgpOw0KICAgICAgICAgICAgICAgICAgICBTdHJpbmcgdmFsID0gaWNzLkdldFZhcih2YXJuYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMubGVuZ3RoKHZhbCkgPT0gMTMpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcodmFybmFtZSwgdmFsKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcsIHVzaW5nIGljcy5HZXRPYmooKQ0KICAgICAgICAgICAgICAgIGFyZ3Muc2V0VmFsU3RyaW5nKCJzaXRlIixpY3MuR2V0VmFyKCJzaXRlIikpOw0KICAgICAgICAgICAgICAgIC8vYXJncy5zZXRWYWxTdHJpbmcoInNpdGUiLChTdHJpbmcpaWNzLkdldE9iaigic2l0ZSIpKTsNCiAgICAgICAgICAgICAgICBhcmdzLnNldFZhbFN0cmluZygiYyIsIkdVX01vZHVsZV9DIik7DQogICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoIm93bmVyX3R5cGUiLGljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSk7DQogICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoIm93bmVyX2lkIixpY3MuR2V0VmFyKCJvd25lcl9pZCIpKTsNCiAgICAgICAgICAgICAgICBhcmdzLnNldFZhbFN0cmluZygiY2lkIixpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSk7DQogICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIikpKXsNCiAgICAgICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoInJlbmRlcm1vZGUiLGljcy5HZXRWYXIoInJlbmRlcm1vZGUiKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiKSE9bnVsbCAmJiBpY3MuR2V0TGlzdChpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSsiOmNhbGx0ZW1wbGF0ZV9hcmdzIikuaGFzRGF0YSgpKXsNCiU+PGljczpsaXN0bG9vcCBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIgJT4nPjwlDQolPjxpY3M6bGlzdGdldCBmaWVsZG5hbWU9InZhbHVlIiBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIgJT4nIG91dHB1dD0ibW9kdWxlX2FyZyIvPjwlDQogICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpKQ0KICAgIHsNCiAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoaWNzLkdldFZhcigibW9kdWxlX2FyZyIpLCBpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpOw0KICAgICAgICBsaW5rVVJMYnVmZmVyLmFwcGVuZCgiXyIraWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikpKTsNCiAgICB9JT48L2ljczpsaXN0bG9vcD48JQ0KICAgIH0NCiAgICAvL1Bhc3MgdGhlIGNhdGVvZ29yeSB2YWx1ZXMgdG8gdGhlIG1vZHVsZXMNCiAgICBmb3IoU3RyaW5nIHBhcmVudF9jYXRlZ29yeSA6IHBhcmVudF9jYXRlZ29yaWVzKQ0KICAgIHsNCiAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcocGFyZW50X2NhdGVnb3J5ICwgaWNzLkdldFZhcihwYXJlbnRfY2F0ZWdvcnkpKTsNCiAgICB9DQogICAgLy9nZXQgdGhlIGxpbmt1cmwgZm9yIHRoZSBtb2R1bGUNCiAgICBpY3MuU2V0VmFyKCJsaW5rdXJsIixsaW5rVVJMYnVmZmVyLnRvU3RyaW5nKCkrIi5odG1sIik7DQogICAgLy8gIGxvZy5pbmZvKCJBUkdTOiAiICsgYXJncy50b1N0cmluZygpKTsNCiAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcsIHJlbW92ZWQgY2FsbCB0byBnZXQgdGFyZ2VkIGlkIGFuZCByZXBsYWNlZCB3aXRoIGNhbGwgdG8gaWNzLkdldE9iaigpDQogICAgaWNzLlNldFZhcigidGFyZ2V0SUQiLCAoU3RyaW5nKWljcy5HZXRPYmooInRhcmdldElEIikpOw0KICAgIGxvZy5kZWJ1ZygiV2hhdCBpcyB0YXJnZWRJRCBvYnRhaW5lZDogIisoU3RyaW5nKWljcy5HZXRPYmooInRhcmdldElEIikpOw0KICAgIGxvZy5kZWJ1ZygiV2hhdCBpcyBwdWJzZXNzOmlkIG9idGFpbmVkOiAiKyhTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCg0KJT48JS0tPHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1Uvc3RhdGljcHViL0dldFB1YnRhcmdldElEIiBzY29wZWQ9Imdsb2JhbCIvPi0tJT48JQ0KICAgIHByb2Nlc3NTU0lNb2R1bGUoaWNzLCBhcmdzLCB0ZW1wbGF0ZV9uYW1lKTsNCiU+PCEtLSNpbmNsdWRlIHZpcnR1YWw9IjwlPWljcy5HZXRWYXIoImxpbmt1cmwiKSU+Ii0tPjwlDQogICAgfQ0KfWVsc2V7DQogICAgaWYoU3RyaW5nVXRpbHMuc3RhcnRzV2l0aChpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIiksICJleHBvcnQiKSl7DQogICAgICAgIFNlc3Npb24gc2VzID0gU2Vzc2lvbkZhY3RvcnkuZ2V0U2Vzc2lvbihpY3MpOw0KICAgICAgICBBc3NldERhdGFNYW5hZ2VyIG1nciA9IChBc3NldERhdGFNYW5hZ2VyKSBzZXMuZ2V0TWFuYWdlcihBc3NldERhdGFNYW5hZ2VyLmNsYXNzLmdldE5hbWUoKSApOw0KICAgICAgICBJTGlzdCBzdGF0aWNQYWdlbGV0SUxpc3QgPSBudWxsOw0KICAgICAgICAvL2xpbmUgYWRkZWQgYnkgTG9rZXNoDQogICAgICAgIGljcy5TZXRWYXIoInRhcmdldElEIiwgKFN0cmluZylpY3MuR2V0T2JqKCJ0YXJnZXRJRCIpKTsNCiAgICAgICAgU3RyaW5nIHNxbFN0bSA9ICJTRUxFQ1QgaWQscmVxdWVzdCBGUk9NIHN0YXRpY19wYWdlbGV0IFdIRVJFIGFzc2V0aWQ9JyIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICInIEFORCB0YXJnZXRpZD0nIiArIGljcy5HZXRWYXIoInRhcmdldElEIikgKyAiJyI7DQogICAgICAgIFN0cmluZyB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgc3RhdGljUGFnZWxldElMaXN0ID0gcnVuU1FMKHNxbFN0bSwgdGFibGVOYW1lcywgaWNzKTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgIT0gLTEwMSAmJiBzdGF0aWNQYWdlbGV0SUxpc3QgIT0gbnVsbCAmJiBzdGF0aWNQYWdlbGV0SUxpc3QubnVtUm93cygpID4gMCl7DQogICAgICAgICAgICAgICAgZm9yIChJTGlzdCByb3cgOiBuZXcgSXRlcmFibGVJTGlzdFdyYXBwZXIoIHN0YXRpY1BhZ2VsZXRJTGlzdCkpew0KICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZmlsZVBhdGggPSBwYXRoUHJlZml4K1N0cmluZ1V0aWxzLnN0cmlwKHJvdy5nZXRWYWx1ZSgicmVxdWVzdCIpLCIvIik7DQogICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHRoZSBvbGQgZmlsZXBhdGggZmlyc3QNCiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKCJEZWxldGluZzogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgYm9vbGVhbiBpc0RlbGV0ZWQgPSBkZWxldGVGaWxlKGljcywgZmlsZVBhdGgpOw0KICAgICAgICAgICAgICAgICAgICAvL2lmIG1vZHVsZSBjb3VsZG4ndCBiZSBzdWNjZXNzZnVsbHkgZGVsZXRlZCwgdGhlIG1vZHVsZSB3b24ndCBiZSB1cGRhdGVkDQogICAgICAgICAgICAgICAgICAgIGlmKCFpc0RlbGV0ZWQpew0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGZpbGVQYXRoICsgIiBjb3VsZCBub3QgYmUgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuIE1vZHVsZToiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikgKyAiIHdvbid0IGJlIHVwZGF0ZWQiKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBTdHJpbmdCdWZmZXIgZXJyc3RyID0gbmV3IFN0cmluZ0J1ZmZlcigpOw0KICAgICAgICAgICAgICAgIHNxbFN0bSA9ICJERUxFVEUgc3RhdGljX3BhZ2VsZXQgV0hFUkUgYXNzZXRpZD0nIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIicgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIjsNCiAgICAgICAgICAgICAgICBsb2cuZGVidWcoIkV4ZWN1dGluZzogIiArIHNxbFN0bSk7DQogICAgICAgICAgICAgICAgaWNzLlNRTCgic3RhdGljX3BhZ2VsZXQiLCBzcWxTdG0sIG51bGwsIC0xLCB0cnVlLCBlcnJzdHIpOw0KICAgICAgICAgICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaCAoTm9TdWNoRmllbGRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICBsb2cuZXJyb3IoIkFuIGVycm9yIG9jY3VyZWQgd2hpbGUgZGVsZXRpbmcgYSBtb2R1bGUgdGhhdCB1c2VkIHRvIGJlIGFuIFNTSSIpOw0KICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgfWNhdGNoIChFeGNlcHRpb24gZSl7DQogICAgICAgICAgICBsb2cuZXJyb3IoIkFuIGVycm9yIG9jY3VyZWQgd2hpbGUgZGVsZXRpbmcgYSBtb2R1bGUgdGhhdCB1c2VkIHRvIGJlIGFuIFNTSSIpOw0KICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBjb21tZW50ZWQgYnkgTG9rZXNoIG9uIDkvMjEvMjAxMA0KICAgICAgICAvKmlmKG51bGwgIT0gc3RhdGljUGFnZWxldElMaXN0KXsNCiAgICAgICAgICAgIHN0YXRpY1BhZ2VsZXRJTGlzdC5mbHVzaCgpOw0KICAgICAgICB9Ki8NCiAgICB9DQogICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIikpICYmIFN0cmluZ1V0aWxzLnN0YXJ0c1dpdGgoaWNzLkdldFZhcigicmVuZGVybW9kZSIpLCAiZGVwcyIpKXsNCiAgICAgICAgZWxlbWVudF90eXBlPSJlbGVtZW50IjsNCg0KICAgIH0NCiU+PHJlbmRlcjpjYWxsdGVtcGxhdGUNCiAgICAgICAgc2xvdG5hbWU9Im1vZHVsZSINCiAgICAgICAgc2l0ZT0nPCU9aWNzLkdldFZhcigic2l0ZSIpICU+Jw0KICAgICAgICB0aWQ9JzwlPWljcy5HZXRWYXIoImVpZCIpICU+Jw0KICAgICAgICB0dHlwZT0iQ1NFbGVtZW50Ig0KICAgICAgICBjb250ZXh0PSIiDQogICAgICAgIGM9IkdVX01vZHVsZV9DIg0KICAgICAgICBjaWQ9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICU+Jw0KICAgICAgICB0bmFtZT0nPCU9dGVtcGxhdGVfbmFtZSAlPicNCiAgICAgICAgc3R5bGU9JzwlPWVsZW1lbnRfdHlwZSAlPic+PCUNCg0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoaWNzLkdldFZhcigicmVuZGVybW9kZSIpKSkNCiAgICB7DQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJyZW5kZXJtb2RlIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigicmVuZGVybW9kZSIpJT4nLz48JQ0KICAgIH0NCiAgICAvL0J1aWxkIGR5bmFtaWMgYXJndW1lbnQgdGhlIG1vZHVsZSBtaWdodCBuZWVkDQogICAgbG9nLmluZm8oInBhZ2Vjcml0ZXJpYSBmb3IgJyIgK2ljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIisgdGVtcGxhdGVfbmFtZSArIicgYXJlICIrIGphdmEudXRpbC5BcnJheXMuYXNMaXN0KGljcy5wYWdlQ3JpdGVyaWFLZXlzKGljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIisgdGVtcGxhdGVfbmFtZSkpICsiIGNhbGxlZCBhcyAiICsgZWxlbWVudF90eXBlICsgIiBmcm9tICIrIGljcy5wYWdlVVJMKCkpOw0KDQogICAgaWYoaWNzLkdldExpc3QoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIpIT1udWxsICYmIGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiKS5oYXNEYXRhKCkpew0KCQklPjxpY3M6bGlzdGxvb3AgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiICU+Jz48JQ0KCQkJJT48aWNzOmxpc3RnZXQgZmllbGRuYW1lPSJ2YWx1ZSIgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiICU+JyBvdXRwdXQ9Im1vZHVsZV9hcmciLz48JQ0KCQkJbG9nLmluZm8gKCJjYWxsdGVtcGxhdGVfYXJncyBmb3IgIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsiICBtb2R1bGVfYXJnOiAiKyBpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgKyI9IitpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpOw0KCQkJaWYoaWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikpIT1udWxsKQ0KCQkJew0KCQkJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSc8JT1pY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgJT4nIHZhbHVlPSc8JT1pY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkgJT4nLz48JQ0KCQkJfWVsc2Ugew0KCQkJCWxvZy53YXJuKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjp0aXRsZV9wcmltYXJ5IiArIiBpcyAiICsgaWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6dGl0bGVfcHJpbWFyeSIpKTsNCgkJCQlsb2cud2FybihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgKyIgaXMgbnVsbCIsIG5ldyBFeGNlcHRpb24oKSk7DQoJCQl9DQoJCSU+PC9pY3M6bGlzdGxvb3A+PCUNCiAgICB9ZWxzZSB7DQogICAgICAgIGlmICghImVsZW1lbnQiLmVxdWFscyhlbGVtZW50X3R5cGUpKSBsb2cud2FybigiY2FsbHRlbXBsYXRlX2FyZ3MgZm9yICciICtpY3MuR2V0VmFyKCJzaXRlIikgKyAiL0dVX01vZHVsZV9DLyIrIHRlbXBsYXRlX25hbWUgKyInIGZvciBtb2R1bGUgJyIraWNzLkdldFZhcigibW9kdWxlX2lkIikrIicgYXJlIGVtcHR5LCBjYWxsZWQgYXMgIiArIGVsZW1lbnRfdHlwZSArICIgZnJvbSAiKyBpY3MucGFnZVVSTCgpKTsNCiAgICB9DQogICAgLy9QYXNzIHRoZSBjYXRlb2dvcnkgdmFsdWVzIHRvIHRoZSBtb2R1bGVzDQogICAgZm9yKFN0cmluZyBwYXJlbnRfY2F0ZWdvcnkgOiBwYXJlbnRfY2F0ZWdvcmllcykNCiAgICB7DQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSI8JT1wYXJlbnRfY2F0ZWdvcnkgJT4iIHZhbHVlPSc8JT1pY3MuR2V0VmFyKHBhcmVudF9jYXRlZ29yeSkgJT4nLz48JQ0KICAgIH0NCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoImxvY2FsZSIpKSkNCgkgICAgeyU+ICAgIDxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9jYWxlIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigibG9jYWxlIikgJT4nLz48JX0NCgklPjwvcmVuZGVyOmNhbGx0ZW1wbGF0ZT48JQ0KICAgIH0NCn0NCmVsc2UNCnsgJT48YnIvPg0KTm8gdGVtcGxhdGUgc2VsZWN0ZWQgZm9yIG1vZHVsZTo8JT1pY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSAlPg0KPGljczpsb2dtc2cgbXNnPSc8JT0iTm8gdGVtcGxhdGUgc2VsZWN0ZWQgZm9yIG1vZHVsZToiK2ljcy5HZXRWYXIoIm1vZHVsZV9pZCIpJT4nLz4NCjxici8+PCV9DQolPjwlIQ0KICAgIExvZyBsb2cgPSBMb2dGYWN0b3J5LmdldExvZygiZWR1Lmdlb3JnZXRvd24ud3d3Lk1vZHVsZURpc3BhdGNoZXIiKTsNCiAgICBzdGF0aWMgU3RyaW5nIHBhdGhQcmVmaXggPSAiIjsNCg0KICAgIC8qKg0KICAgICAqIFRoaXMgbWV0aG9kIHRyaWVzIHRvIGRlbGV0ZSB0aGUgZmlsZSBzcGVjaWZpZWQgaW4gZmlsZVBhdGguDQogICAgICogTG9ncyBhIHdhcm5pbmcgaWYgdGhlIGZpbGUgZG9lc24ndCBleGlzdCBvciBpZiB0aGVyZSBpcyBhbiBpc3N1ZSBkZWxldGluZyB0aGUgZmlsZQ0KICAgICAqIEZpbGVVdGlscyBpcyBub3QgYmVpbmcgdXNlZCBiZWNhdXNlIHNwZWNpZmljIHdhcm5pbmdzIG5lZWQgdG8gYmUgbG9nZ2VkLg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGRlbGV0ZUZpbGUoSUNTIGljcywgU3RyaW5nIGZpbGVQYXRoKXsNCiAgICAgICAgRmlsZSBmaWxlVG9EZWxldGUgPSBuZXcgRmlsZShmaWxlUGF0aCk7DQogIA==ICAgICAgLy8gTWFrZSBzdXJlIHRoZSBmaWxlIG9yIGRpcmVjdG9yeSBleGlzdHMgYW5kIGlzbid0IHdyaXRlIHByb3RlY3RlZA0KICAgICAgICBpZiAoIWZpbGVUb0RlbGV0ZS5leGlzdHMoKSkNCiAgICAgICAgew0KICAgICAgICAgICAgLy90aGlzIGlzIG5vdCBuZWNlc3NhcmlseSBhbiBlcnJvciBjb25kaXRpb24sIGhlbmNlIHdlIGFyZSBOT1Qgc2V0dGluZyBoYXNFcnJvciB0byB0cnVlLg0KICAgICAgICAgICAgbG9nLndhcm4oIkRlbGV0ZTogbm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeTogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCFmaWxlVG9EZWxldGUuY2FuV3JpdGUoKSl7DQogICAgICAgICAgICBsb2cud2FybigiRGVsZXRlOiB3cml0ZSBwcm90ZWN0ZWQ6ICIgKyBmaWxlUGF0aCk7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCg0KICAgICAgICAvLyBJZiBpdCBpcyBhIGRpcmVjdG9yeSwgbWFrZSBzdXJlIGl0IGlzIGVtcHR5DQogICAgICAgIGlmIChmaWxlVG9EZWxldGUuaXNEaXJlY3RvcnkoKSkgew0KICAgICAgICAgICAgU3RyaW5nW10gZmlsZXMgPSBmaWxlVG9EZWxldGUubGlzdCgpOw0KICAgICAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApDQogICAgICAgICAgICAgICAgbG9nLndhcm4oIkRlbGV0ZTogZGlyZWN0b3J5IG5vdCBlbXB0eTogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIEF0dGVtcHQgdG8gZGVsZXRlIGl0DQogICAgICAgIGJvb2xlYW4gc3VjY2VzcyA9IGZpbGVUb0RlbGV0ZS5kZWxldGUoKTsNCg0KICAgICAgICBpZiAoIXN1Y2Nlc3MpDQogICAgICAgIHsNCiAgICAgICAgICAgIGxvZy53YXJuKCJEZWxldGU6IGRlbGV0aW9uIGZhaWxlZCBmb3IgIiArIGZpbGVQYXRoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlew0KICAgICAgICAgICAgbG9nLmluZm8oIlN1Y2Nlc3MgaW4gZGVsZXRpbmcgIiArIGZpbGVQYXRoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc3VjY2VzczsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBydW5zIFNRTCBzdG1zIHByb3ZpZGVkIGluIHRoZSBhcmd1bWVudHMNCiAgICAgKiBAcGFyYW0gc3FsU3RtDQogICAgICogQHBhcmFtIHRhYmxlcw0KICAgICAqIEBwYXJhbSBpY3MNCiAgICAgKiBAcmV0dXJuIC0tIGlMaXN0IG9mIHRoZSByZXN1bHRzZXQgZnJvbSBEQg0KICAgICAqLw0KICAgIHB1YmxpYyBJTGlzdCBydW5TUUwoU3RyaW5nIHNxbFN0bSwgU3RyaW5nIHRhYmxlcywgSUNTIGljcyl7DQogICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgIFN0cmluZ0J1ZmZlciBlcnJzdHIgPSBuZXcgU3RyaW5nQnVmZmVyKCk7DQogICAgICAgIGxvZy5kZWJ1ZygiQ2FsbGluZzogIiArIHNxbFN0bSk7DQogICAgICAgIElMaXN0IHNxbE91dHB1dElMaXN0ID0gbnVsbDsNCiAgICAgICAgc3FsT3V0cHV0SUxpc3QgPSBpY3MuU1FMKHRhYmxlcywgc3FsU3RtLCAic3FsT3V0cHV0SUxpc3QiLCAtMSwgdHJ1ZSwgZXJyc3RyKTsNCg0KICAgICAgICBpZihpY3MuR2V0RXJybm8oKTwwKQ0KICAgICAgICB7DQogICAgICAgICAgICBpZihpY3MuR2V0RXJybm8oKSA9PSAtMTAxKXsNCiAgICAgICAgICAgICAgICBsb2cuaW5mbygiTm8gcm93cyByZXR1cm5lZCBmb3I6ICIgKyBzcWxTdG0pOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKCAiU1FMIEVycm9yICIgKyBpY3MuR2V0RXJybm8oKSArICIgb24gIiArIHNxbFN0bSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNxbE91dHB1dElMaXN0Ow0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIEdldHMgZGVmYXVsdCBmb2xkZXIgdG8gd2hpY2ggc3RhdGljIHB1Ymxpc2ggd2lsbCBwdWJsaXNoIHRoZSBhc3NldHMgdG8NCiAgICAgKiBAcGFyYW0gaWNzDQogICAgICovDQogICAgcHVibGljIHZvaWQgZ2V0UGF0aFByZWZpeChJQ1MgaWNzKXsNCiAgICAgICAgcGF0aFByZWZpeCA9IGljcy5HZXRQcm9wZXJ0eSgiY3MucGdleHBvcnRmb2xkZXIiLCAiZnV0dXJldGVuc2UuaW5pIiwgdHJ1ZSk7DQogICAgICAgIGlmKCFTdHJpbmdVdGlscy5lbmRzV2l0aChwYXRoUHJlZml4LCIvIikpew0KICAgICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhQcmVmaXgrIi8iOw0KICAgICAgICB9DQogICAgICAgIGxvZy50cmFjZSgiUGF0aCBwcmVmaXggd2FzIHNldCB0byBkZWZhdWx0ICIgKyBwYXRoUHJlZml4KTsNCiAgICAgICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJiYXNlRGlyIikpKXsNCiAgICAgICAgICAgIC8vIE1vZGlmaWVkOiByZ2lsbCwgMjAxMC0wOS0xNywgcmVwbGFjZWQgd2l0aCAoU3RyaW5nKWljcy5HZXRPYmooImJhc2VEaXIiKQ0KICAgICAgICAgICAgLy9wYXRoUHJlZml4ID0gcGF0aFByZWZpeCArIFN0cmluZ1V0aWxzLnN0cmlwKGljcy5HZXRWYXIoImJhc2VEaXIiKSwiLyIpKyIvIjsNCiAgICAgICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4ICsgU3RyaW5nVXRpbHMuc3RyaXAoKFN0cmluZylpY3MuR2V0T2JqKCJiYXNlRGlyIiksIi8iKSsiLyI7DQogICAgICAgICAgICBsb2cuZGVidWcoImJhc2VEaXIgYXBwZW5kZWQgdG8gcGF0aFByZWZpeC4gTmV3IHBhdGhQcmVmaXg6ICIgKyBwYXRoUHJlZml4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgU3RyaW5nIGNhbGN1bGF0ZUluY2x1ZGVQYXRoUHJlZml4KElDUyBpY3MpDQogICAgew0KICAgICAgICBpY3MuQ2xlYXJFcnJubygpOw0KICAgICAgICBGVFZhbExpc3QgYXJnc2xpc3QgPSBuZXcgRlRWYWxMaXN0KCk7DQogICAgICAgIGFyZ3NsaXN0LnB1dCgic2l0ZW5hbWUiLGljcy5HZXRWYXIoInNpdGUiKSk7DQogICAgICAgIGFyZ3NsaXN0LnB1dCgicHJlZml4Iiwic2EiKTsNCiAgICAgICAgaWNzLkNhbGxFbGVtZW50KCJHVS9jb21tb24vR2V0U2l0ZUF0dHJpYnV0ZXMiLGFyZ3NsaXN0KTsNCiAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgPT0gMCB8fCBpY3MuR2V0RXJybm8oKSA9PSAtNTAwKXsNCiAgICAgICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgICAgICBTdHJpbmcgc3RhdGljX3B1YmRlc3RpbmF0aW9uID0gaWNzLkdldFByb3BlcnR5KCJzdGF0aWNfcHViZGVzdGluYXRpb24iLCAiZ3VfY3VzdG9tLnByb3BlcnRpZXMiLCB0cnVlKTsNCiAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90Qmxhbmsoc3RhdGljX3B1YmRlc3RpbmF0aW9uKSAmJiAoIVN0cmluZ1V0aWxzLmVxdWFsc0lnbm9yZUNhc2UoIlllcyIsIGljcy5HZXRWYXIoInNhOnN1cHByZXNzX3NpdGVfbmFtZSIpKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzYTpzdGF0aWNfc3ViZG9tYWluIikgKyAiLyIgKyBpY3MuR2V0VmFyKCJzaXRlIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmKFN0cmluZ1V0aWxzLmlzTm90Qmxhbmsoc3RhdGljX3B1YmRlc3RpbmF0aW9uKSAmJiBTdHJpbmdVdGlscy5lcXVhbHNJZ25vcmVDYXNlKCJZZXMiLCBpY3MuR2V0VmFyKCJzYTpzdXBwcmVzc19zaXRlX25hbWUiKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzYTpzdGF0aWNfc3ViZG9tYWluIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmKCFTdHJpbmdVdGlscy5lcXVhbHNJZ25vcmVDYXNlKCJZZXMiLCBpY3MuR2V0VmFyKCJzYTpzdXBwcmVzc19zaXRlX25hbWUiKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzaXRlIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgcmV0dXJuICIvIjsNCiAgICB9DQogICAgcHVibGljIHZvaWQgcHJvY2Vzc1NTSU1vZHVsZShJQ1MgaWNzLCBGVFZhbExpc3QgYXJncywgU3RyaW5nIHRlbXBsYXRlX25hbWUpew0KICAgICAgICBTdHJpbmcgdGVtcGxhdGVBcmdzID0gYXJncy50b1N0cmluZygpOw0KICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgLy8gY2hhbmdpbmcsIGljcy5HZXRTU1ZhcigicHVic2VzczppZCIpIHRvIChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpDQogICAgICAgIFN0cmluZyBzcWxTdG0gPSAiU0VMRUNUIGNvdW50KCopIGFzIHByZXZwdWJjb3VudCBGUk9NIHN0YXRpY19wYWdlbGV0IFdIRVJFIHJlcXVlc3Q9JyIgKyBpY3MuR2V0VmFyKCJsaW5rdXJsIikgKyAiJyIgKyAiIEFORCB0YXJnZXRpZD0nIiArIGljcy5HZXRWYXIoInRhcmdldElEIikgKyAiJyBBTkQgcHVic2Vzc2lvbmlkPSciICsgaWNzLkdldFNTVmFyKCJwdWJzZXNzOmlkIikgKyAiJyI7DQogICAgICAgIFN0cmluZyB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgSUxpc3QgcHJldlB1YklMaXN0ID0gcnVuU1FMKHNxbFN0bSwgdGFibGVOYW1lcywgaWNzKTsNCiAgICAgICAgaWYobnVsbCAhPSBwcmV2UHViSUxpc3QgJiYgcHJldlB1YklMaXN0Lmhhc0RhdGEoKSl7DQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaW50IHByZXZQdWJDb3VudCA9IC0xOw0KICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBwcmV2UHViSUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgcHJldlB1YkNvdW50ID0gSW50ZWdlci5wYXJzZUludChyb3cuZ2V0VmFsdWUoInByZXZwdWJjb3VudCIpKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKHByZXZQdWJDb3VudCA+IDApew0KICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIk1vZHVsZSBhbHJlYWR5IHB1Ymxpc2hlZDoiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlKXsNCiAgICAgICAgICAgICAgICBpY3MuU2V0T2JqKCJoYXNFcnJvciIsICJ0cnVlIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChOb1N1Y2hGaWVsZEV4Y2VwdGlvbiBlKXsNCiAgICAgICAgICAgICAgICBpY3MuU2V0T2JqKCJoYXNFcnJvciIsICJ0cnVlIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyBjb21tZW50ZWQgYnkgTG9rZXNoIDkvMjEvMjAxMCBhcyBwZXIgRG9sZidzIGZlZWRiYWNrDQogICAgICAgIC8qaWYobnVsbCAhPSBwcmV2UHViSUxpc3Qpew0KICAgICAgICAgICAgcHJldlB1YklMaXN0LmZsdXNoKCk7DQogICAgICAgIH0qLw0KICAgICAgICBzcWxTdG0gPSAiU0VMRUNUIGNvdW50KCopIGFzIGFwcHJvdmVkYXNzZXRjb3VudCBGUk9NIEFwcHJvdmVkQXNzZXRzIFdIRVJFIGFzc2V0aWQ9JyIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICInIiArICIgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIEFORCB0c3RhdGU9J0EnIjsNCiAgICAgICAgdGFibGVOYW1lcyA9ICJBcHByb3ZlZEFzc2V0cyI7DQogICAgICAgIElMaXN0IGFwcHJvdmVkQXNzZXRJTGlzdCA9IHJ1blNRTChzcWxTdG0sIHRhYmxlTmFtZXMsIGljcyk7DQogICAgICAgIGlmKG51bGwgIT0gYXBwcm92ZWRBc3NldElMaXN0JiYgYXBwcm92ZWRBc3NldElMaXN0Lmhhc0RhdGEoKSl7DQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaW50IGFwcHJvdmVkQXNzZXRDb3VudCA9IC0xOw0KICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBhcHByb3ZlZEFzc2V0SUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgYXBwcm92ZWRBc3NldENvdW50ID0gSW50ZWdlci5wYXJzZUludChyb3cuZ2V0VmFsdWUoImFwcHJvdmVkYXNzZXRjb3VudCIpKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGFwcHJvdmVkQXNzZXRDb3VudCA8IDEpew0KICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIk1vZHVsZSBpcyBpbiBoZWxkIHN0YXRlIGFuZCB3b24ndCBiZSBwdWJsaXNoZWQ6IiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChOdW1iZXJGb3JtYXRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSwgZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoTm9TdWNoRmllbGRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSwgZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy9jb21tZW50ZWQgYnkgTG9rZXNoIG9uIDkvMjEvMjAxMA0KICAgICAgICAvKmlmKG51bGwgIT0gcHJldlB1YklMaXN0KXsNCiAgICAgICAgICAgIHByZXZQdWJJTGlzdC5mbHVzaCgpOw0KICAgICAgICB9Ki8NCiAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCi8vcmVhZCB0aGUgcmVuZGVyZWQgcGFnZSBjb250ZW50IGludG8gYSBzdHJpbmcuDQoNCi8vICAgICAgICBsb2cuZGVidWcoIkNvbnRleHQgaXM6ICIgKyBpY3MuR2V0VmFyKCJjb250ZXh0IikpOw0KICAgICAgICBTdHJpbmcgdGhlUGFnZSA9IGljcy5SZWFkUGFnZSAoIGljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIiArIFN0cmluZ1V0aWxzLnN0cmlwKHRlbXBsYXRlX25hbWUsIi8iKSwgYXJncyk7DQogICAgICAgIGFyZ3MucmVtb3ZlQWxsKCk7DQogICAgICAgIGlmICggdGhlUGFnZSA9PSBudWxsICkgIHsNCiAgICAgICAgICAgIGludCBlcnJubyA9IGljcy5HZXRFcnJubygpOw0KICAgICAgICAgICAgaWYoZXJybm8gIT0gMCl7DQogICAgICAgICAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciAoZXJybm8iICsgZXJybm8gKyAiKSB3aGlsZSByZWFkaW5nIHdyYXBwZXIgd2l0aCBtb2R1bGUgdXJsPSIgKyBpY3MuR2V0VmFyKCJsaW5rdXJsIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgIHsNCiAgICAgICAgICAgIGdldFBhdGhQcmVmaXgoaWNzKTsNCiAgICAgICAgICAgIGxvZy5kZWJ1ZygiUHVibGlzaGluZyBTU0kgTW9kdWxlOiAiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgU2Vzc2lvbiBzZXMgPSBTZXNzaW9uRmFjdG9yeS5nZXRTZXNzaW9uKGljcyk7DQogICAgICAgICAgICBBc3NldERhdGFNYW5hZ2VyIG1nciA9IChBc3NldERhdGFNYW5hZ2VyKSBzZXMuZ2V0TWFuYWdlcihBc3NldERhdGFNYW5hZ2VyLmNsYXNzLmdldE5hbWUoKSApOw0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIElMaXN0IHN0YXRpY1BhZ2VsZXRJTGlzdCA9IG51bGw7DQogICAgICAgICAgICAgICAgc3FsU3RtID0gIlNFTEVDVCBpZCxyZXF1ZXN0IEZST00gc3RhdGljX3BhZ2VsZXQgV0hFUkUgb3duZXJpZD0nIiArIChTdHJpbmcpaWNzLkdldE9iaigic3RhdGljUGFnZWxldElEIikgKyAiJyBBTkQgYXNzZXRpZD0nIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIicgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIjsNCiAgICAgICAgICAgICAgICB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgICAgICAgICBzdGF0aWNQYWdlbGV0SUxpc3QgPSBydW5TUUwoc3FsU3RtLCB0YWJsZU5hbWVzLCBpY3MpOw0KDQogICAgICAgICAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgIT0gLTEwMSAmJiBzdGF0aWNQYWdlbGV0SUxpc3QgIT0gbnVsbCAmJiBzdGF0aWNQYWdlbGV0SUxpc3QubnVtUm93cygpID4gMCl7DQogICAgICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBzdGF0aWNQYWdlbGV0SUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBmaWxlUGF0aCA9IHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAocm93LmdldFZhbHVlKCJyZXF1ZXN0IiksIi8iKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHRoZSBvbGQgZmlsZXBhdGggZmlyc3QNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygiRGVsZXRpbmc6ICIgKyBmaWxlUGF0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICBib29sZWFuIGlzRGVsZXRlZCA9IGRlbGV0ZUZpbGUoaWNzLCBmaWxlUGF0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIG1vZHVsZSBjb3VsZG4ndCBiZSBzdWNjZXNzZnVsbHkgZGVsZXRlZCwgdGhlIG1vZHVsZSB3b24ndCBiZSB1cGRhdGVkDQogICAgICAgICAgICAgICAgICAgICAgICBpZighaXNEZWxldGVkKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3NldHRpbmcgdGhlIGxpbmt1cmwgZm9yIHNzaSBiYWNrIHRvIHRoZSBvbGQgbW9kdWxlIHRoYXQgd2FzIHB1Ymxpc2hlZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljcy5TZXRWYXIoImxpbmt1cmwiLCByb3cuZ2V0VmFsdWUoInJlcXVlc3QiKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGZpbGVQYXRoICsgIiBjb3VsZCBub3QgYmUgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuIE1vZHVsZToiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikgKyAiIHdvbid0IGJlIHVwZGF0ZWQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vb2xkIG1vZHVsZSB3YXMgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQsIGhlbmNlIHB1Ymxpc2hpbmcgbmV3IG1vZHVsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQXR0ZW1wdGluZyB0byB3cml0ZSBhbiB1cGRhdGVkIG1vZHVsZSB0byAiICsgcGF0aFByZWZpeCtTdHJpbmdVdGlscy5zdHJpcChpY3MuR2V0VmFyKCJsaW5rdXJsIiksIi8iKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsZVV0aWxzLndyaXRlU3RyaW5nVG9GaWxlKG5ldyBGaWxlKHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAoaWNzLkdldFZhcigibGlua3VybCIpLCIvIikpLCB0aGVQYWdlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVyYWJsZTxBc3NldERhdGE+IGFzc2V0cyA9IG1nci5yZWFkKCBBcnJheXMuPEFzc2V0SWQ+YXNMaXN0KCBuZXcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFzc2V0SWRJbXBsKCAic3RhdGljX3BhZ2VsZXQiLCBMb25nLnBhcnNlTG9uZyhyb3cuZ2V0VmFsdWUoImlkIikpICkpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaXN0PEFzc2V0RGF0YT4gc0Fzc2V0cyA9IG5ldyBBcnJheUxpc3Q8QXNzZXREYXRhPigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIEFzc2V0RGF0YSBhIDogYXNzZXRzICkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNBc3NldHMuYWRkKCBhICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsodGVtcGxhdGVBcmdzKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoInRlbXBsYXRlX2FyZ3MiKS5zZXREYXRhKHRlbXBsYXRlQXJncyk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoYW5naW5nLCBpY3MuR2V0U1NWYXIoInB1YnNlc3M6aWQiKSB0byAoU3RyaW5nKWljcy5HZXRPYmooInB1YnNlc3M6aWQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuY29udGFpbnMoaWNzLkdldFZhcigibGlua3VybCIpLCAiXyIpICYmIFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuZ2V0QXR0cmlidXRlRGF0YSgib3duZXJpZCIpLnNldERhdGEoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuZ2V0QXR0cmlidXRlRGF0YSgib3duZXJpZCIpLnNldERhdGEoIiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5nZXRBdHRyaWJ1dGVEYXRhKCJwdWJzZXNzaW9uaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoICJ0ZW1wbGF0ZSIgKS5zZXREYXRhKFN0cmluZ1V0aWxzLnN0cmlwKHRlbXBsYXRlX25hbWUsICIvIikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoICJyZXF1ZXN0IiApLnNldERhdGEoIGljcy5HZXRWYXIoImxpbmt1cmwiKSApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZ3IudXBkYXRlKCBzQXNzZXRzICk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBdHRlbXB0aW5nIHRvIHdyaXRlIHRoZSBuZXcgbW9kdWxlIHRvICIgKyBwYXRoUHJlZml4K1N0cmluZ1V0aWxzLnN0cmlwKGljcy5HZXRWYXIoImxpbmt1cmwiKSwiLyIpKTsNCiAgICAgICAgICAgICAgICAgICAgRmlsZVV0aWxzLndyaXRlU3RyaW5nVG9GaWxlKG5ldyBGaWxlKHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAoaWNzLkdldFZhcigibGlua3VybCIpLCIvIikpLCB0aGVQYWdlKTsNCg0KICAgICAgICAgICAgICAgICAgICBNdXRhYmxlQXNzZXREYXRhIGFzc2V0RGF0YSA9IG1nci5uZXdBc3NldERhdGEoInN0YXRpY19wYWdlbGV0IiwiIik7DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJuYW1lIikuc2V0RGF0YShpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSk7DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJyZXF1ZXN0Iikuc2V0RGF0YShpY3MuR2V0VmFyKCJsaW5rdXJsIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgiYXNzZXRpZCIpLnNldERhdGEoaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgiYXNzZXR0eXBlIikuc2V0RGF0YSgiR1VfTW9kdWxlX0MiKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuY29udGFpbnMoaWNzLkdldFZhcigibGlua3VybCIpLCAiXyIpICYmIFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXREYXRhLmdldEF0dHJpYnV0ZURhdGEoIm93bmVyaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigic3RhdGljUGFnZWxldElEIikpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJ0ZW1wbGF0ZSIpLnNldERhdGEoU3RyaW5nVXRpbHMuc3RyaXAodGVtcGxhdGVfbmFtZSwgIi8iKSk7DQogICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsodGVtcGxhdGVBcmdzKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgidGVtcGxhdGVfYXJncyIpLnNldERhdGEodGVtcGxhdGVBcmdzKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgidGFyZ2V0aWQiKS5zZXREYXRhKGljcy5HZXRWYXIoInRhcmdldElEIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSggIlB1Ymxpc3QiICkuc2V0RGF0YSggQXJyYXlzLmFzTGlzdChpY3MuR2V0VmFyKCJzaXRlIikgKSApOw0KICAgICAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgICAgICAgICAgICAgLy8gY2hhbmdpbmcsIGljcy5HZXRTU1ZhcigicHVic2VzczppZCIpIHRvIChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpDQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJwdWJzZXNzaW9uaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCg0KICAgICAgICAgICAgICAgICAgICBtZ3IuaW5zZXJ0KEFycmF5cy48QXNzZXREYXRhPmFzTGlzdChhc3NldERhdGEpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGUpew0KICAgICAgICAgICAgICAgIGljcy5TZXRPYmooImhhc0Vycm9yIiwgInRydWUiKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkVycm9yIG9jY3VycmVkIGluIGNvbnZlcnRpbmcgc3RhdGljX3BhZ2VsZXQgaWQgdG8gTG9uZyIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSk7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0U3RhY2tUcmFjZSgpLnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2F0Y2ggKE5vU3VjaEZpZWxkRXhjZXB0aW9uIGUpew0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3Igb2NjdXJyZWQgaW4gcmV0cmlldmluZyBpZCBvciByZXF1ZXN0IGZyb20gbW9kdWxlZGlwYXRjaGVyIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRTdGFja1RyYWNlKCkudG9TdHJpbmcoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoSU9FeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgd3JpdGluZyB0byAiICsgcGF0aFByZWZpeCtTdHJpbmdVdGlscy5zdHJpcChpY3MuR2V0VmFyKCJsaW5rdXJsIiksIi8iKSk7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRTdGFja1RyYWNlKCkudG9TdHJpbmcoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoQXNzZXRBY2Nlc3NFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3Igb2NjdXJyZWQgaW4gdXBkYXRpbmcgc3RhdGljX3BhZ2VsZXQiKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldFN0YWNrVHJhY2UoKS50b1N0cmluZygpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiU+PC9jczpmdGNzPg==";

    private void AAtestDecode() throws IOException {
        //String x = "PCVAIHRhZ2xpYiBwcmVmaXg9ImNzIiB1cmk9ImZ1dHVyZXRlbnNlX2NzL2Z0Y3MxXzAudGxkIg0KICAgICAgICAlPjwlQCB0YWdsaWIgcHJlZml4PSJpY3MiIHVyaT0iZnV0dXJldGVuc2VfY3MvaWNzLnRsZCINCiAgICAgICAgJT48JUAgdGFnbGliIHByZWZpeD0icmVuZGVyIiB1cmk9ImZ1dHVyZXRlbnNlX2NzL3JlbmRlci50bGQiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJDT00uRnV0dXJlVGVuc2UuSW50ZXJmYWNlcy4qLA0KICAgICAgICAgICAgICAgICAgIENPTS5GdXR1cmVUZW5zZS5VdGlsLmZ0TWVzc2FnZSwNCiAgICAgICAgICAgICAgICAgICBDT00uRnV0dXJlVGVuc2UuVXRpbC5mdEVycm9ycyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sYW5nLlN0cmluZ1V0aWxzIg0KICAgICAgICAlPjwlQCBwYWdlIGltcG9ydD0ib3JnLmFwYWNoZS5jb21tb25zLmlvLkZpbGVVdGlscyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sb2dnaW5nLkxvZyINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9Im9yZy5hcGFjaGUuY29tbW9ucy5sb2dnaW5nLkxvZ0ZhY3RvcnkiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJqYXZhLmlvLkZpbGUiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJDT00uRnV0dXJlVGVuc2UuVXRpbC5JdGVyYWJsZUlMaXN0V3JhcHBlciINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5BcnJheXMiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5hc3NldGFwaS5kYXRhLkFzc2V0RGF0YSINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5MaXN0Ig0KICAgICAgICAlPjwlQCBwYWdlIGltcG9ydD0iamF2YS5pby5JT0V4Y2VwdGlvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmNvbW1vbi5Bc3NldEFjY2Vzc0V4Y2VwdGlvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmRhdGEuQXNzZXRJZCINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5vcGVubWFya2V0LnhjZWxlcmF0ZS5hc3NldC5Bc3NldElkSW1wbCINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5BcnJheUxpc3QiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5hc3NldGFwaS5kYXRhLkFzc2V0RGF0YU1hbmFnZXIiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5zeXN0ZW0uU2Vzc2lvbkZhY3RvcnkiDQogICAgICAgICU+PCVAIHBhZ2UgaW1wb3J0PSJjb20uZmF0d2lyZS5zeXN0ZW0uU2Vzc2lvbiINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImNvbS5mYXR3aXJlLmFzc2V0YXBpLmRhdGEuTXV0YWJsZUFzc2V0RGF0YSINCiAgICAgICAgJT48JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC5FbnVtZXJhdGlvbiINCiAgICAgICAgJT48Y3M6ZnRjcz48JS0tIEdVL2NvbW1vbi9Nb2R1bGVEaXNwYXRjaGVyDQoNCiAgICBXcml0ZW4gQnk6IFBlZHJhbSBCYWdoZXJpbmlhDQoNCglEYXRlOiA0LzIyLzA5DQoNCg0KCVB1cnBvc2U6IExvYWRzIHRoZSBtb2R1bGUgYW5kIGRldGVybWluZXMgdGhlIHJlcXVpcmVkIGNhbGxpbmcgYXJndW1lbnRzIGFuZCBkZXRlcm1pbmVzIHRoZSB0ZW1wbGF0ZSB0aGF0IGlzIGFzc29jaWF0ZWQgdG8gdGhlIG1vZHVsZSBhbmQNCgkgICAgICAgICBjYWxscyBpdC4gVGhpcyBlbGVtZW50IGlzIGNhbGxlZCBieSBNb2R1bGVsaXN0IHRlbXBsYXRlIGFuZCBMYXlvdXRSZW5kZXJlciB3aXRoIHNjb3BlIGdsb2JhbC4NCg0KSU5QVVQNCiAgICBtb2R1bGVfaWQgIC0gbW9kdWxlIGFzc2V0IGlkDQogICAgb3duZXJfaWQgIC0gY2FsbGluZyBhc3NldCBpZA0KICAgIG93bmVyX3R5cGUgIC0gY2FsbGluZyBhc3NldCB0eXBlDQpPVVRQVVQNCg0KLS0lPjwlDQolPjxpY3M6aWYgY29uZGl0aW9uPSc8JT1pY3MuR2V0VmFyKCJlaWQiKSE9bnVsbCU+Jz48JQ0KJT48aWNzOnRoZW4+PCUNCiU+PHJlbmRlcjpsb2dkZXAgY2lkPSc8JT1pY3MuR2V0VmFyKCJlaWQiKSU+JyBjPSJDU0VsZW1lbnQiLz48JQ0KJT48L2ljczp0aGVuPjwvaWNzOmlmPjwlDQoNCmxvZy5pbmZvKCJDYWxsZWQgd2l0aCBvd25lcjogIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsiIG93bmVyOiAiICArIGljcy5HZXRWYXIoIm93bmVyX2lkIikgKyIgIiAgKyBpY3MuR2V0VmFyKCJvd25lcl90eXBlIikpOw0KDQogICAgaWYoaWNzLkdldFZhcigicGFnZW5hbWUiKSA9PSBudWxsKXsNCiAgICAgICAgbG9nLndhcm4oInBhZ2VuYW1lIGlzIG51bGwiLCBuZXcgRXhjZXB0aW9uKCkpOw0KICAgIH0NCiAgICAvL0xvYWQgYWxsIHRoZSBtb2R1bGVzIGF0dHJpYnV0ZXMNCiU+PHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1UvY29tbW9uL0dldEFsbEF0dHJpYnV0ZXMiIHNjb3BlZD0iZ2xvYmFsIj48JQ0KJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9Imxvb2t1cF9pZCIgdmFsdWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICU+Jy8+PCUNCiU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJsb29rdXBfdHlwZSIgdmFsdWU9IkdVX01vZHVsZV9DIi8+PCUNCiU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwcmVmaXgiIHZhbHVlPSI8JT1pY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSAlPiIvPjwlDQolPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0iZGVidWciIHZhbHVlPSJubyIgLz48JQ0KJT48L3JlbmRlcjpjYWxsZWxlbWVudD48JQ0KDQogICAgLy9hcyBhIHJlcXVpcmVkIG1vZHVsZSBhdHRyaWJ1dGUgaWYgaXRzIHJlcXVpcmVkIGJ5IHRoaXMgbW9kdWxlLg0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoaWNzLkdldFZhcigib3duZXJfaWQiKSkpDQogICAgew0KICAgICAgICBpY3MuU2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjpvd25lcl9pZCIsaWNzLkdldFZhcigib3duZXJfaWQiKSk7DQogICAgICAgIGljcy5TZXRWYXIoaWNzLkdldFZhcigib3duZXJfaWQiKSsiOm93bmVyX3R5cGUiLGljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSk7DQogICAgICAgICU+PHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1UvY29tbW9uL0dldEFsbEF0dHJpYnV0ZXMiIHNjb3BlZD0iZ2xvYmFsIj48JQ0KICAgICAgICAgICAlPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9va3VwX2lkIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigib3duZXJfaWQiKSAlPicvPjwlDQogICAgICAgICAgICU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJsb29rdXBfdHlwZSIgdmFsdWU9IjwlPWljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSAlPiIvPjwlDQogICAgICAgICAgICU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwcmVmaXgiIHZhbHVlPSI8JT1pY3MuR2V0VmFyKCJvd25lcl9pZCIpICU+Ii8+PCUNCiAgICAgICAgICAgJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9ImRlYnVnIiB2YWx1ZT0ibm8iIC8+PCUNCiAgICAgICAgICU+PC9yZW5kZXI6Y2FsbGVsZW1lbnQ+PCUNCiAgICB9DQovL0lmIHBhZ2luYXRpb24gZXhpc3Qgd2UgbmVlZCBmb3JtYXQgaXQgc28gaXQgY2FuIGJlIHBpY2tlZCB1cCBhcyByZXF1aXJlZCBhdHRyaWJ1dGUNCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoInBhZ2UiKSkpDQogICAgew0KICAgICAgICBpY3MuU2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjpwYWdlIixpY3MuR2V0VmFyKCJwYWdlIikpOw0KDQogICAgfQ0KDQogICAgU3RyaW5nIHBhcmVudEF0dHJpYnV0ZXM9IiI7DQogICAgU3RyaW5nW10gcGFyZW50X2NhdGVnb3JpZXMgPW5ldyBTdHJpbmdbMF07DQoNCg0KLy9HZXQgbGlzdCBvZiBjYXRlZ29yeSBwYXJlbnQgYXR0cmlidXRlIHdlIG5lZWQuDQovL1RoaXMgaXMgcHJpbWFybHkgdXNlZCBieSB0aGUgcHVzaHB1bGwgbGlzdCB0byByZXN0cmljdCBjaGlsZHJlbiB0byBzcGVjaWZpYyBwYXJlbnRzIHdpdGgNCi8vYSBjYXRlZ29yeSBjb250cmFpbnMuDQogICAgaWYoaWNzLkdldExpc3QoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpwYXJlbnRmaWx0ZXJfYXJncyIpIT1udWxsICYmIGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiKS5oYXNEYXRhKCkpDQogICAgew0KCQklPjxpY3M6bGlzdGxvb3AgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiICU+Jz48JQ0KCQklPjxpY3M6bGlzdGdldCBmaWVsZG5hbWU9InZhbHVlIiBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpwYXJlbnRmaWx0ZXJfYXJncyIgJT4nIG91dHB1dD0iY2F0ZWdvcnlfYXJnIi8+PCUNCiAgICBpZihTdHJpbmdVdGlscy5pc0JsYW5rKHBhcmVudEF0dHJpYnV0ZXMpKQ0KICAgIHsNCiAgICAgICAgcGFyZW50QXR0cmlidXRlcyA9IGljcy5HZXRWYXIoImNhdGVnb3J5X2FyZyIpOw0KICAgIH0NCiAgICBlbHNlDQogICAgew0KICAgICAgICBwYXJlbnRBdHRyaWJ1dGVzID0gcGFyZW50QXR0cmlidXRlcysiLCIraWNzLkdldFZhcigiY2F0ZWdvcnlfYXJnIik7DQogICAgfQ0KJT48L2ljczpsaXN0bG9vcD48JQ0KICAgIH0NCiAgICBsb2cuaW5mbygicGFyZW50QXR0cmlidXRlczogIisgcGFyZW50QXR0cmlidXRlcyArIiwgbGlzdCBwYXJlbnRmaWx0ZXJfYXJncyBpcyBudWxsPSIrKGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6cGFyZW50ZmlsdGVyX2FyZ3MiKT09bnVsbCkpOw0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsocGFyZW50QXR0cmlidXRlcykpDQogICAgLy9XZSB3YW50IHRvIGdldCB0aGUgZ2V0IGNhdGVnb3J5IGluZm9ybWF0aW9uIGZyb20gdGhlIG93bmVyIGFzc2V0IHNvIHdlIGxvYWQgdGhlIGFzc2V0cw0KICAgIC8vYXR0cmlidXRlcyBhZ2FpbiBidXQgdGhpcyB0aW1lIHdlIHNwZWNpZnkgdGhlIGluaGVydGVkIGF0dHJpYnV0ZXMgd2UgbmVlZC4NCiAgICB7DQogICAgICAgIGljcy5SZW1vdmVWYXIoInByZWZpeCIpOw0KCQklPjxyZW5kZXI6Y2FsbGVsZW1lbnQgZWxlbWVudG5hbWU9IkdVL2NvbW1vbi9HZXRBbGxBdHRyaWJ1dGVzIiBzY29wZWQ9Imdsb2JhbCI+PCUNCgkJJT48cmVuZGVyOmFyZ3VtZW50IG5hbWU9Imxvb2t1cF9pZCIgdmFsdWU9JzwlPWljcy5HZXRWYXIoIm93bmVyX2lkIikgJT4nLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9va3VwX3R5cGUiIHZhbHVlPSc8JT1pY3MuR2V0VmFyKCJvd25lcl90eXBlIikgJT4nLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0icHJlZml4IiB2YWx1ZT0iPCU9aWNzLkdldFZhcigib3duZXJfaWQiKSAlPiIvPjwlDQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJwYXJlbnRfYXR0cmlidXRlcyIgdmFsdWU9IjwlPXBhcmVudEF0dHJpYnV0ZXMgJT4iLz48JQ0KCQklPjxyZW5kZXI6YXJndW1lbnQgbmFtZT0iZGVidWciIHZhbHVlPSJubyIgLz48JQ0KCQklPjwvcmVuZGVyOmNhbGxlbGVtZW50PjwlDQoNCiAgICAgICAgLy9CdWlsZCB0aGUgdmFsdWUgc3RyaW5nIG9mIHRoZSBjYXRlZ29yaWVzIHdlIHdhbnQgaWUgZ2VuZXJhbF9jYXRlZ29yeT0iMTk5OSxuZXdzIg0KICAgICAgICBwYXJlbnRfY2F0ZWdvcmllcyA9IFN0cmluZ1V0aWxzLnNwbGl0KHBhcmVudEF0dHJpYnV0ZXMsIiwiKTsNCg0KICAgICAgICBmb3IoU3RyaW5nIHBhcmVudF9jYXRlZ29yeSA6IHBhcmVudF9jYXRlZ29yaWVzKQ0KICAgICAgICB7DQogICAgICAgICAgICBJTGlzdCBjdXJyZW50X2NhdGVnb3J5X2xpc3QgPSBpY3MuR2V0TGlzdChpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitwYXJlbnRfY2F0ZWdvcnkpOw0KICAgICAgICAgICAgU3RyaW5nIGN1cnJlbnRfdmFsdWU9IiI7DQogICAgICAgICAgICBpZihudWxsICE9IGN1cnJlbnRfY2F0ZWdvcnlfbGlzdCAmJiBjdXJyZW50X2NhdGVnb3J5X2xpc3QuaGFzRGF0YSgpKXsNCiAgICAgICAgICAgICAgICBmb3IgKElMaXN0IHJvdyA6IG5ldyBJdGVyYWJsZUlMaXN0V3JhcHBlciggY3VycmVudF9jYXRlZ29yeV9saXN0KSl7DQogICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzQmxhbmsoY3VycmVudF92YWx1ZSkpDQogICAgICAgICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdmFsdWU9cm93LmdldFZhbHVlKCJ2YWx1ZSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2UNCiAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF92YWx1ZT1jdXJyZW50X3ZhbHVlKyIsIityb3cuZ2V0VmFsdWUoInZhbHVlIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoY3VycmVudF92YWx1ZSkpDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgaWNzLlNldFZhcihwYXJlbnRfY2F0ZWdvcnksY3VycmVudF92YWx1ZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgIH0NCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpmaWx0ZXJfYXNzZXRfdGVtcGxhdGUiKSkpew0KICAgICAgICBTdHJpbmcgdGVtcGxhdGVfbmFtZSA9IGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpmaWx0ZXJfYXNzZXRfdGVtcGxhdGUiKTsNCiAgICAgICAgU3RyaW5nIGVsZW1lbnRfdHlwZSA9IGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfc3R5bGUiKTsNCiAgICAgICAgbG9nLmRlYnVnKCJNb2R1bGUgIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIiB3aXRoIG93bmVyaWQ9ICIgKyBpY3MuR2V0VmFyKCJvd25lcl9pZCIpICsgIiByZW5kZXJtb2RlOiAiICsgaWNzLkdldFZhcigicmVuZGVybW9kZSIpICsgIiBzc2k9ICIgKyBpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6c3RhdGljX1NTSSIpKTsNCiAgICAgICAgLy9pZiB0aGUgbW9kdWxlIGlzIGNvbmZpZ3VyZWQgYXMgU1NJIGFuZCByZW5kZXJtb2RlIHN0YXJ0cyB3aXRoIGV4cG9ydCA9IHN0YXRpYyBwdWIsIHRoZW4NCiAgICAgICAgLy8gcHJvY2VzcyB0aGUgbW9kdWxlIGFzIGFuIFNTSQ0KICAgICAgICBpZigiWWVzIi5lcXVhbHNJZ25vcmVDYXNlKGljcy5HZXRWYXIoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpzdGF0aWNfU1NJIikpICYmIChTdHJpbmdVdGlscy5zdGFydHNXaXRoKGljcy5HZXRWYXIoInJlbmRlcm1vZGUiKSwgImV4cG9ydCIpIHx8IFN0cmluZ1V0aWxzLnN0YXJ0c1dpdGgoaWNzLkdldFZhcigicmVuZGVybW9kZSIpLCAiZGVwcyIpKSl7DQogICAgICAgICAgICAvKmlmKCJZZXMiLmVxdWFsc0lnbm9yZUNhc2UoaWNzLkdldFZhcihpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSsiOnN0YXRpY19TU0kiKSkpew0KICAgICAgICAgICAgKi8gIGxvZy5kZWJ1ZygiTW9kdWxlICIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICIgaXMgYSBTU0kgd2l0aCBvd25lcmlkPSAiICsgaWNzLkdldFZhcigib3duZXJfaWQiKSk7DQogICAgICAgICAgICBpZighU3RyaW5nVXRpbHMuc3RhcnRzV2l0aChpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIiksICJkZXBzIikpew0KICAgICAgICAgICAgICAgIFN0cmluZ0J1ZmZlciBsaW5rVVJMYnVmZmVyID0gbmV3IFN0cmluZ0J1ZmZlcigpOw0KICAgICAgICAgICAgICAgIGxpbmtVUkxidWZmZXIuYXBwZW5kKGNhbGN1bGF0ZUluY2x1ZGVQYXRoUHJlZml4KGljcykpOw0KICAgICAgICAgICAgICAgIGxpbmtVUkxidWZmZXIuYXBwZW5kKCJpbmNsdWRlcy9tb2R1bGVzLyIraWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgIC8vcmVhZCB0aGUgbW9kdWxlIG91dHB1dCBpbnRvIGEgU3RyaW5nICh0aGVQYWdlKQ0KICAgICAgICAgICAgICAgIEZUVmFsTGlzdCBhcmdzID0gbmV3IEZUVmFsTGlzdCgpOw0KICAgICAgICAgICAgICAgIGFyZ3MucmVtb3ZlQWxsKCk7DQogICAgICAgICAgICAgICAgU3RyaW5nIG91dHB1dCA9IG51bGw7DQogICAgICAgICAgICAgICAgRW51bWVyYXRpb24gZW4gPSBpY3MuR2V0VmFycygpOw0KICAgICAgICAgICAgICAgIHdoaWxlIChlbi5oYXNNb3JlRWxlbWVudHMoKSkNCiAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgIFN0cmluZyB2YXJuYW1lID0gKFN0cmluZyllbi5uZXh0RWxlbWVudCgpOw0KICAgICAgICAgICAgICAgICAgICBTdHJpbmcgdmFsID0gaWNzLkdldFZhcih2YXJuYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMubGVuZ3RoKHZhbCkgPT0gMTMpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcodmFybmFtZSwgdmFsKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcsIHVzaW5nIGljcy5HZXRPYmooKQ0KICAgICAgICAgICAgICAgIGFyZ3Muc2V0VmFsU3RyaW5nKCJzaXRlIixpY3MuR2V0VmFyKCJzaXRlIikpOw0KICAgICAgICAgICAgICAgIC8vYXJncy5zZXRWYWxTdHJpbmcoInNpdGUiLChTdHJpbmcpaWNzLkdldE9iaigic2l0ZSIpKTsNCiAgICAgICAgICAgICAgICBhcmdzLnNldFZhbFN0cmluZygiYyIsIkdVX01vZHVsZV9DIik7DQogICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoIm93bmVyX3R5cGUiLGljcy5HZXRWYXIoIm93bmVyX3R5cGUiKSk7DQogICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoIm93bmVyX2lkIixpY3MuR2V0VmFyKCJvd25lcl9pZCIpKTsNCiAgICAgICAgICAgICAgICBhcmdzLnNldFZhbFN0cmluZygiY2lkIixpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSk7DQogICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIikpKXsNCiAgICAgICAgICAgICAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoInJlbmRlcm1vZGUiLGljcy5HZXRWYXIoInJlbmRlcm1vZGUiKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiKSE9bnVsbCAmJiBpY3MuR2V0TGlzdChpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSsiOmNhbGx0ZW1wbGF0ZV9hcmdzIikuaGFzRGF0YSgpKXsNCiU+PGljczpsaXN0bG9vcCBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIgJT4nPjwlDQolPjxpY3M6bGlzdGdldCBmaWVsZG5hbWU9InZhbHVlIiBsaXN0bmFtZT0nPCU9aWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIgJT4nIG91dHB1dD0ibW9kdWxlX2FyZyIvPjwlDQogICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpKQ0KICAgIHsNCiAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcoaWNzLkdldFZhcigibW9kdWxlX2FyZyIpLCBpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpOw0KICAgICAgICBsaW5rVVJMYnVmZmVyLmFwcGVuZCgiXyIraWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikpKTsNCiAgICB9JT48L2ljczpsaXN0bG9vcD48JQ0KICAgIH0NCiAgICAvL1Bhc3MgdGhlIGNhdGVvZ29yeSB2YWx1ZXMgdG8gdGhlIG1vZHVsZXMNCiAgICBmb3IoU3RyaW5nIHBhcmVudF9jYXRlZ29yeSA6IHBhcmVudF9jYXRlZ29yaWVzKQ0KICAgIHsNCiAgICAgICAgYXJncy5zZXRWYWxTdHJpbmcocGFyZW50X2NhdGVnb3J5ICwgaWNzLkdldFZhcihwYXJlbnRfY2F0ZWdvcnkpKTsNCiAgICB9DQogICAgLy9nZXQgdGhlIGxpbmt1cmwgZm9yIHRoZSBtb2R1bGUNCiAgICBpY3MuU2V0VmFyKCJsaW5rdXJsIixsaW5rVVJMYnVmZmVyLnRvU3RyaW5nKCkrIi5odG1sIik7DQogICAgLy8gIGxvZy5pbmZvKCJBUkdTOiAiICsgYXJncy50b1N0cmluZygpKTsNCiAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcsIHJlbW92ZWQgY2FsbCB0byBnZXQgdGFyZ2VkIGlkIGFuZCByZXBsYWNlZCB3aXRoIGNhbGwgdG8gaWNzLkdldE9iaigpDQogICAgaWNzLlNldFZhcigidGFyZ2V0SUQiLCAoU3RyaW5nKWljcy5HZXRPYmooInRhcmdldElEIikpOw0KICAgIGxvZy5kZWJ1ZygiV2hhdCBpcyB0YXJnZWRJRCBvYnRhaW5lZDogIisoU3RyaW5nKWljcy5HZXRPYmooInRhcmdldElEIikpOw0KICAgIGxvZy5kZWJ1ZygiV2hhdCBpcyBwdWJzZXNzOmlkIG9idGFpbmVkOiAiKyhTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCg0KJT48JS0tPHJlbmRlcjpjYWxsZWxlbWVudCBlbGVtZW50bmFtZT0iR1Uvc3RhdGljcHViL0dldFB1YnRhcmdldElEIiBzY29wZWQ9Imdsb2JhbCIvPi0tJT48JQ0KICAgIHByb2Nlc3NTU0lNb2R1bGUoaWNzLCBhcmdzLCB0ZW1wbGF0ZV9uYW1lKTsNCiU+PCEtLSNpbmNsdWRlIHZpcnR1YWw9IjwlPWljcy5HZXRWYXIoImxpbmt1cmwiKSU+Ii0tPjwlDQogICAgfQ0KfWVsc2V7DQogICAgaWYoU3RyaW5nVXRpbHMuc3RhcnRzV2l0aChpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIiksICJleHBvcnQiKSl7DQogICAgICAgIFNlc3Npb24gc2VzID0gU2Vzc2lvbkZhY3RvcnkuZ2V0U2Vzc2lvbihpY3MpOw0KICAgICAgICBBc3NldERhdGFNYW5hZ2VyIG1nciA9IChBc3NldERhdGFNYW5hZ2VyKSBzZXMuZ2V0TWFuYWdlcihBc3NldERhdGFNYW5hZ2VyLmNsYXNzLmdldE5hbWUoKSApOw0KICAgICAgICBJTGlzdCBzdGF0aWNQYWdlbGV0SUxpc3QgPSBudWxsOw0KICAgICAgICAvL2xpbmUgYWRkZWQgYnkgTG9rZXNoDQogICAgICAgIGljcy5TZXRWYXIoInRhcmdldElEIiwgKFN0cmluZylpY3MuR2V0T2JqKCJ0YXJnZXRJRCIpKTsNCiAgICAgICAgU3RyaW5nIHNxbFN0bSA9ICJTRUxFQ1QgaWQscmVxdWVzdCBGUk9NIHN0YXRpY19wYWdlbGV0IFdIRVJFIGFzc2V0aWQ9JyIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICInIEFORCB0YXJnZXRpZD0nIiArIGljcy5HZXRWYXIoInRhcmdldElEIikgKyAiJyI7DQogICAgICAgIFN0cmluZyB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgc3RhdGljUGFnZWxldElMaXN0ID0gcnVuU1FMKHNxbFN0bSwgdGFibGVOYW1lcywgaWNzKTsNCiAgICAgICAgdHJ5ew0KICAgICAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgIT0gLTEwMSAmJiBzdGF0aWNQYWdlbGV0SUxpc3QgIT0gbnVsbCAmJiBzdGF0aWNQYWdlbGV0SUxpc3QubnVtUm93cygpID4gMCl7DQogICAgICAgICAgICAgICAgZm9yIChJTGlzdCByb3cgOiBuZXcgSXRlcmFibGVJTGlzdFdyYXBwZXIoIHN0YXRpY1BhZ2VsZXRJTGlzdCkpew0KICAgICAgICAgICAgICAgICAgICBTdHJpbmcgZmlsZVBhdGggPSBwYXRoUHJlZml4K1N0cmluZ1V0aWxzLnN0cmlwKHJvdy5nZXRWYWx1ZSgicmVxdWVzdCIpLCIvIik7DQogICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHRoZSBvbGQgZmlsZXBhdGggZmlyc3QNCiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKCJEZWxldGluZzogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgICAgICAgICAgYm9vbGVhbiBpc0RlbGV0ZWQgPSBkZWxldGVGaWxlKGljcywgZmlsZVBhdGgpOw0KICAgICAgICAgICAgICAgICAgICAvL2lmIG1vZHVsZSBjb3VsZG4ndCBiZSBzdWNjZXNzZnVsbHkgZGVsZXRlZCwgdGhlIG1vZHVsZSB3b24ndCBiZSB1cGRhdGVkDQogICAgICAgICAgICAgICAgICAgIGlmKCFpc0RlbGV0ZWQpew0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGZpbGVQYXRoICsgIiBjb3VsZCBub3QgYmUgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuIE1vZHVsZToiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikgKyAiIHdvbid0IGJlIHVwZGF0ZWQiKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBTdHJpbmdCdWZmZXIgZXJyc3RyID0gbmV3IFN0cmluZ0J1ZmZlcigpOw0KICAgICAgICAgICAgICAgIHNxbFN0bSA9ICJERUxFVEUgc3RhdGljX3BhZ2VsZXQgV0hFUkUgYXNzZXRpZD0nIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIicgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIjsNCiAgICAgICAgICAgICAgICBsb2cuZGVidWcoIkV4ZWN1dGluZzogIiArIHNxbFN0bSk7DQogICAgICAgICAgICAgICAgaWNzLlNRTCgic3RhdGljX3BhZ2VsZXQiLCBzcWxTdG0sIG51bGwsIC0xLCB0cnVlLCBlcnJzdHIpOw0KICAgICAgICAgICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH1jYXRjaCAoTm9TdWNoRmllbGRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICBsb2cuZXJyb3IoIkFuIGVycm9yIG9jY3VyZWQgd2hpbGUgZGVsZXRpbmcgYSBtb2R1bGUgdGhhdCB1c2VkIHRvIGJlIGFuIFNTSSIpOw0KICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgfWNhdGNoIChFeGNlcHRpb24gZSl7DQogICAgICAgICAgICBsb2cuZXJyb3IoIkFuIGVycm9yIG9jY3VyZWQgd2hpbGUgZGVsZXRpbmcgYSBtb2R1bGUgdGhhdCB1c2VkIHRvIGJlIGFuIFNTSSIpOw0KICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBjb21tZW50ZWQgYnkgTG9rZXNoIG9uIDkvMjEvMjAxMA0KICAgICAgICAvKmlmKG51bGwgIT0gc3RhdGljUGFnZWxldElMaXN0KXsNCiAgICAgICAgICAgIHN0YXRpY1BhZ2VsZXRJTGlzdC5mbHVzaCgpOw0KICAgICAgICB9Ki8NCiAgICB9DQogICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJyZW5kZXJtb2RlIikpICYmIFN0cmluZ1V0aWxzLnN0YXJ0c1dpdGgoaWNzLkdldFZhcigicmVuZGVybW9kZSIpLCAiZGVwcyIpKXsNCiAgICAgICAgZWxlbWVudF90eXBlPSJlbGVtZW50IjsNCg0KICAgIH0NCiU+PHJlbmRlcjpjYWxsdGVtcGxhdGUNCiAgICAgICAgc2xvdG5hbWU9Im1vZHVsZSINCiAgICAgICAgc2l0ZT0nPCU9aWNzLkdldFZhcigic2l0ZSIpICU+Jw0KICAgICAgICB0aWQ9JzwlPWljcy5HZXRWYXIoImVpZCIpICU+Jw0KICAgICAgICB0dHlwZT0iQ1NFbGVtZW50Ig0KICAgICAgICBjb250ZXh0PSIiDQogICAgICAgIGM9IkdVX01vZHVsZV9DIg0KICAgICAgICBjaWQ9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICU+Jw0KICAgICAgICB0bmFtZT0nPCU9dGVtcGxhdGVfbmFtZSAlPicNCiAgICAgICAgc3R5bGU9JzwlPWVsZW1lbnRfdHlwZSAlPic+PCUNCg0KICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoaWNzLkdldFZhcigicmVuZGVybW9kZSIpKSkNCiAgICB7DQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSJyZW5kZXJtb2RlIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigicmVuZGVybW9kZSIpJT4nLz48JQ0KICAgIH0NCiAgICAvL0J1aWxkIGR5bmFtaWMgYXJndW1lbnQgdGhlIG1vZHVsZSBtaWdodCBuZWVkDQogICAgbG9nLmluZm8oInBhZ2Vjcml0ZXJpYSBmb3IgJyIgK2ljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIisgdGVtcGxhdGVfbmFtZSArIicgYXJlICIrIGphdmEudXRpbC5BcnJheXMuYXNMaXN0KGljcy5wYWdlQ3JpdGVyaWFLZXlzKGljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIisgdGVtcGxhdGVfbmFtZSkpICsiIGNhbGxlZCBhcyAiICsgZWxlbWVudF90eXBlICsgIiBmcm9tICIrIGljcy5wYWdlVVJMKCkpOw0KDQogICAgaWYoaWNzLkdldExpc3QoaWNzLkdldFZhcigibW9kdWxlX2lkIikrIjpjYWxsdGVtcGxhdGVfYXJncyIpIT1udWxsICYmIGljcy5HZXRMaXN0KGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiKS5oYXNEYXRhKCkpew0KCQklPjxpY3M6bGlzdGxvb3AgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiICU+Jz48JQ0KCQkJJT48aWNzOmxpc3RnZXQgZmllbGRuYW1lPSJ2YWx1ZSIgbGlzdG5hbWU9JzwlPWljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKyI6Y2FsbHRlbXBsYXRlX2FyZ3MiICU+JyBvdXRwdXQ9Im1vZHVsZV9hcmciLz48JQ0KCQkJbG9nLmluZm8gKCJjYWxsdGVtcGxhdGVfYXJncyBmb3IgIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsiICBtb2R1bGVfYXJnOiAiKyBpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgKyI9IitpY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkpOw0KCQkJaWYoaWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikpIT1udWxsKQ0KCQkJew0KCQkJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSc8JT1pY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgJT4nIHZhbHVlPSc8JT1pY3MuR2V0VmFyKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjoiK2ljcy5HZXRWYXIoIm1vZHVsZV9hcmciKSkgJT4nLz48JQ0KCQkJfWVsc2Ugew0KCQkJCWxvZy53YXJuKGljcy5HZXRWYXIoIm93bmVyX2lkIikrIjp0aXRsZV9wcmltYXJ5IiArIiBpcyAiICsgaWNzLkdldFZhcihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6dGl0bGVfcHJpbWFyeSIpKTsNCgkJCQlsb2cud2FybihpY3MuR2V0VmFyKCJvd25lcl9pZCIpKyI6IitpY3MuR2V0VmFyKCJtb2R1bGVfYXJnIikgKyIgaXMgbnVsbCIsIG5ldyBFeGNlcHRpb24oKSk7DQoJCQl9DQoJCSU+PC9pY3M6bGlzdGxvb3A+PCUNCiAgICB9ZWxzZSB7DQogICAgICAgIGlmICghImVsZW1lbnQiLmVxdWFscyhlbGVtZW50X3R5cGUpKSBsb2cud2FybigiY2FsbHRlbXBsYXRlX2FyZ3MgZm9yICciICtpY3MuR2V0VmFyKCJzaXRlIikgKyAiL0dVX01vZHVsZV9DLyIrIHRlbXBsYXRlX25hbWUgKyInIGZvciBtb2R1bGUgJyIraWNzLkdldFZhcigibW9kdWxlX2lkIikrIicgYXJlIGVtcHR5LCBjYWxsZWQgYXMgIiArIGVsZW1lbnRfdHlwZSArICIgZnJvbSAiKyBpY3MucGFnZVVSTCgpKTsNCiAgICB9DQogICAgLy9QYXNzIHRoZSBjYXRlb2dvcnkgdmFsdWVzIHRvIHRoZSBtb2R1bGVzDQogICAgZm9yKFN0cmluZyBwYXJlbnRfY2F0ZWdvcnkgOiBwYXJlbnRfY2F0ZWdvcmllcykNCiAgICB7DQoJCSU+PHJlbmRlcjphcmd1bWVudCBuYW1lPSI8JT1wYXJlbnRfY2F0ZWdvcnkgJT4iIHZhbHVlPSc8JT1pY3MuR2V0VmFyKHBhcmVudF9jYXRlZ29yeSkgJT4nLz48JQ0KICAgIH0NCiAgICBpZihTdHJpbmdVdGlscy5pc05vdEJsYW5rKGljcy5HZXRWYXIoImxvY2FsZSIpKSkNCgkgICAgeyU+ICAgIDxyZW5kZXI6YXJndW1lbnQgbmFtZT0ibG9jYWxlIiB2YWx1ZT0nPCU9aWNzLkdldFZhcigibG9jYWxlIikgJT4nLz48JX0NCgklPjwvcmVuZGVyOmNhbGx0ZW1wbGF0ZT48JQ0KICAgIH0NCn0NCmVsc2UNCnsgJT48YnIvPg0KTm8gdGVtcGxhdGUgc2VsZWN0ZWQgZm9yIG1vZHVsZTo8JT1pY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSAlPg0KPGljczpsb2dtc2cgbXNnPSc8JT0iTm8gdGVtcGxhdGUgc2VsZWN0ZWQgZm9yIG1vZHVsZToiK2ljcy5HZXRWYXIoIm1vZHVsZV9pZCIpJT4nLz4NCjxici8+PCV9DQolPjwlIQ0KICAgIExvZyBsb2cgPSBMb2dGYWN0b3J5LmdldExvZygiZWR1Lmdlb3JnZXRvd24ud3d3Lk1vZHVsZURpc3BhdGNoZXIiKTsNCiAgICBzdGF0aWMgU3RyaW5nIHBhdGhQcmVmaXggPSAiIjsNCg0KICAgIC8qKg0KICAgICAqIFRoaXMgbWV0aG9kIHRyaWVzIHRvIGRlbGV0ZSB0aGUgZmlsZSBzcGVjaWZpZWQgaW4gZmlsZVBhdGguDQogICAgICogTG9ncyBhIHdhcm5pbmcgaWYgdGhlIGZpbGUgZG9lc24ndCBleGlzdCBvciBpZiB0aGVyZSBpcyBhbiBpc3N1ZSBkZWxldGluZyB0aGUgZmlsZQ0KICAgICAqIEZpbGVVdGlscyBpcyBub3QgYmVpbmcgdXNlZCBiZWNhdXNlIHNwZWNpZmljIHdhcm5pbmdzIG5lZWQgdG8gYmUgbG9nZ2VkLg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGRlbGV0ZUZpbGUoSUNTIGljcywgU3RyaW5nIGZpbGVQYXRoKXsNCiAgICAgICAgRmlsZSBmaWxlVG9EZWxldGUgPSBuZXcgRmlsZShmaWxlUGF0aCk7DQogIA==";//ICAgICAgLy8gTWFrZSBzdXJlIHRoZSBmaWxlIG9yIGRpcmVjdG9yeSBleGlzdHMgYW5kIGlzbid0IHdyaXRlIHByb3RlY3RlZA0KICAgICAgICBpZiAoIWZpbGVUb0RlbGV0ZS5leGlzdHMoKSkNCiAgICAgICAgew0KICAgICAgICAgICAgLy90aGlzIGlzIG5vdCBuZWNlc3NhcmlseSBhbiBlcnJvciBjb25kaXRpb24sIGhlbmNlIHdlIGFyZSBOT1Qgc2V0dGluZyBoYXNFcnJvciB0byB0cnVlLg0KICAgICAgICAgICAgbG9nLndhcm4oIkRlbGV0ZTogbm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeTogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCFmaWxlVG9EZWxldGUuY2FuV3JpdGUoKSl7DQogICAgICAgICAgICBsb2cud2FybigiRGVsZXRlOiB3cml0ZSBwcm90ZWN0ZWQ6ICIgKyBmaWxlUGF0aCk7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCg0KICAgICAgICAvLyBJZiBpdCBpcyBhIGRpcmVjdG9yeSwgbWFrZSBzdXJlIGl0IGlzIGVtcHR5DQogICAgICAgIGlmIChmaWxlVG9EZWxldGUuaXNEaXJlY3RvcnkoKSkgew0KICAgICAgICAgICAgU3RyaW5nW10gZmlsZXMgPSBmaWxlVG9EZWxldGUubGlzdCgpOw0KICAgICAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApDQogICAgICAgICAgICAgICAgbG9nLndhcm4oIkRlbGV0ZTogZGlyZWN0b3J5IG5vdCBlbXB0eTogIiArIGZpbGVQYXRoKTsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIEF0dGVtcHQgdG8gZGVsZXRlIGl0DQogICAgICAgIGJvb2xlYW4gc3VjY2VzcyA9IGZpbGVUb0RlbGV0ZS5kZWxldGUoKTsNCg0KICAgICAgICBpZiAoIXN1Y2Nlc3MpDQogICAgICAgIHsNCiAgICAgICAgICAgIGxvZy53YXJuKCJEZWxldGU6IGRlbGV0aW9uIGZhaWxlZCBmb3IgIiArIGZpbGVQYXRoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlew0KICAgICAgICAgICAgbG9nLmluZm8oIlN1Y2Nlc3MgaW4gZGVsZXRpbmcgIiArIGZpbGVQYXRoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc3VjY2VzczsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBydW5zIFNRTCBzdG1zIHByb3ZpZGVkIGluIHRoZSBhcmd1bWVudHMNCiAgICAgKiBAcGFyYW0gc3FsU3RtDQogICAgICogQHBhcmFtIHRhYmxlcw0KICAgICAqIEBwYXJhbSBpY3MNCiAgICAgKiBAcmV0dXJuIC0tIGlMaXN0IG9mIHRoZSByZXN1bHRzZXQgZnJvbSBEQg0KICAgICAqLw0KICAgIHB1YmxpYyBJTGlzdCBydW5TUUwoU3RyaW5nIHNxbFN0bSwgU3RyaW5nIHRhYmxlcywgSUNTIGljcyl7DQogICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgIFN0cmluZ0J1ZmZlciBlcnJzdHIgPSBuZXcgU3RyaW5nQnVmZmVyKCk7DQogICAgICAgIGxvZy5kZWJ1ZygiQ2FsbGluZzogIiArIHNxbFN0bSk7DQogICAgICAgIElMaXN0IHNxbE91dHB1dElMaXN0ID0gbnVsbDsNCiAgICAgICAgc3FsT3V0cHV0SUxpc3QgPSBpY3MuU1FMKHRhYmxlcywgc3FsU3RtLCAic3FsT3V0cHV0SUxpc3QiLCAtMSwgdHJ1ZSwgZXJyc3RyKTsNCg0KICAgICAgICBpZihpY3MuR2V0RXJybm8oKTwwKQ0KICAgICAgICB7DQogICAgICAgICAgICBpZihpY3MuR2V0RXJybm8oKSA9PSAtMTAxKXsNCiAgICAgICAgICAgICAgICBsb2cuaW5mbygiTm8gcm93cyByZXR1cm5lZCBmb3I6ICIgKyBzcWxTdG0pOw0KICAgICAgICAgICAgfWVsc2V7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKCAiU1FMIEVycm9yICIgKyBpY3MuR2V0RXJybm8oKSArICIgb24gIiArIHNxbFN0bSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNxbE91dHB1dElMaXN0Ow0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIEdldHMgZGVmYXVsdCBmb2xkZXIgdG8gd2hpY2ggc3RhdGljIHB1Ymxpc2ggd2lsbCBwdWJsaXNoIHRoZSBhc3NldHMgdG8NCiAgICAgKiBAcGFyYW0gaWNzDQogICAgICovDQogICAgcHVibGljIHZvaWQgZ2V0UGF0aFByZWZpeChJQ1MgaWNzKXsNCiAgICAgICAgcGF0aFByZWZpeCA9IGljcy5HZXRQcm9wZXJ0eSgiY3MucGdleHBvcnRmb2xkZXIiLCAiZnV0dXJldGVuc2UuaW5pIiwgdHJ1ZSk7DQogICAgICAgIGlmKCFTdHJpbmdVdGlscy5lbmRzV2l0aChwYXRoUHJlZml4LCIvIikpew0KICAgICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhQcmVmaXgrIi8iOw0KICAgICAgICB9DQogICAgICAgIGxvZy50cmFjZSgiUGF0aCBwcmVmaXggd2FzIHNldCB0byBkZWZhdWx0ICIgKyBwYXRoUHJlZml4KTsNCiAgICAgICAgaWYoU3RyaW5nVXRpbHMuaXNOb3RCbGFuayhpY3MuR2V0VmFyKCJiYXNlRGlyIikpKXsNCiAgICAgICAgICAgIC8vIE1vZGlmaWVkOiByZ2lsbCwgMjAxMC0wOS0xNywgcmVwbGFjZWQgd2l0aCAoU3RyaW5nKWljcy5HZXRPYmooImJhc2VEaXIiKQ0KICAgICAgICAgICAgLy9wYXRoUHJlZml4ID0gcGF0aFByZWZpeCArIFN0cmluZ1V0aWxzLnN0cmlwKGljcy5HZXRWYXIoImJhc2VEaXIiKSwiLyIpKyIvIjsNCiAgICAgICAgICAgIHBhdGhQcmVmaXggPSBwYXRoUHJlZml4ICsgU3RyaW5nVXRpbHMuc3RyaXAoKFN0cmluZylpY3MuR2V0T2JqKCJiYXNlRGlyIiksIi8iKSsiLyI7DQogICAgICAgICAgICBsb2cuZGVidWcoImJhc2VEaXIgYXBwZW5kZWQgdG8gcGF0aFByZWZpeC4gTmV3IHBhdGhQcmVmaXg6ICIgKyBwYXRoUHJlZml4KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgU3RyaW5nIGNhbGN1bGF0ZUluY2x1ZGVQYXRoUHJlZml4KElDUyBpY3MpDQogICAgew0KICAgICAgICBpY3MuQ2xlYXJFcnJubygpOw0KICAgICAgICBGVFZhbExpc3QgYXJnc2xpc3QgPSBuZXcgRlRWYWxMaXN0KCk7DQogICAgICAgIGFyZ3NsaXN0LnB1dCgic2l0ZW5hbWUiLGljcy5HZXRWYXIoInNpdGUiKSk7DQogICAgICAgIGFyZ3NsaXN0LnB1dCgicHJlZml4Iiwic2EiKTsNCiAgICAgICAgaWNzLkNhbGxFbGVtZW50KCJHVS9jb21tb24vR2V0U2l0ZUF0dHJpYnV0ZXMiLGFyZ3NsaXN0KTsNCiAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgPT0gMCB8fCBpY3MuR2V0RXJybm8oKSA9PSAtNTAwKXsNCiAgICAgICAgICAgIGljcy5DbGVhckVycm5vKCk7DQogICAgICAgICAgICBTdHJpbmcgc3RhdGljX3B1YmRlc3RpbmF0aW9uID0gaWNzLkdldFByb3BlcnR5KCJzdGF0aWNfcHViZGVzdGluYXRpb24iLCAiZ3VfY3VzdG9tLnByb3BlcnRpZXMiLCB0cnVlKTsNCiAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90Qmxhbmsoc3RhdGljX3B1YmRlc3RpbmF0aW9uKSAmJiAoIVN0cmluZ1V0aWxzLmVxdWFsc0lnbm9yZUNhc2UoIlllcyIsIGljcy5HZXRWYXIoInNhOnN1cHByZXNzX3NpdGVfbmFtZSIpKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzYTpzdGF0aWNfc3ViZG9tYWluIikgKyAiLyIgKyBpY3MuR2V0VmFyKCJzaXRlIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmKFN0cmluZ1V0aWxzLmlzTm90Qmxhbmsoc3RhdGljX3B1YmRlc3RpbmF0aW9uKSAmJiBTdHJpbmdVdGlscy5lcXVhbHNJZ25vcmVDYXNlKCJZZXMiLCBpY3MuR2V0VmFyKCJzYTpzdXBwcmVzc19zaXRlX25hbWUiKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzYTpzdGF0aWNfc3ViZG9tYWluIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmKCFTdHJpbmdVdGlscy5lcXVhbHNJZ25vcmVDYXNlKCJZZXMiLCBpY3MuR2V0VmFyKCJzYTpzdXBwcmVzc19zaXRlX25hbWUiKSkpew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBpY3MuR2V0VmFyKCJzaXRlIikgKyAiLyI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgcmV0dXJuICIvIjsNCiAgICB9DQogICAgcHVibGljIHZvaWQgcHJvY2Vzc1NTSU1vZHVsZShJQ1MgaWNzLCBGVFZhbExpc3QgYXJncywgU3RyaW5nIHRlbXBsYXRlX25hbWUpew0KICAgICAgICBTdHJpbmcgdGVtcGxhdGVBcmdzID0gYXJncy50b1N0cmluZygpOw0KICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgLy8gY2hhbmdpbmcsIGljcy5HZXRTU1ZhcigicHVic2VzczppZCIpIHRvIChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpDQogICAgICAgIFN0cmluZyBzcWxTdG0gPSAiU0VMRUNUIGNvdW50KCopIGFzIHByZXZwdWJjb3VudCBGUk9NIHN0YXRpY19wYWdlbGV0IFdIRVJFIHJlcXVlc3Q9JyIgKyBpY3MuR2V0VmFyKCJsaW5rdXJsIikgKyAiJyIgKyAiIEFORCB0YXJnZXRpZD0nIiArIGljcy5HZXRWYXIoInRhcmdldElEIikgKyAiJyBBTkQgcHVic2Vzc2lvbmlkPSciICsgaWNzLkdldFNTVmFyKCJwdWJzZXNzOmlkIikgKyAiJyI7DQogICAgICAgIFN0cmluZyB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgSUxpc3QgcHJldlB1YklMaXN0ID0gcnVuU1FMKHNxbFN0bSwgdGFibGVOYW1lcywgaWNzKTsNCiAgICAgICAgaWYobnVsbCAhPSBwcmV2UHViSUxpc3QgJiYgcHJldlB1YklMaXN0Lmhhc0RhdGEoKSl7DQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaW50IHByZXZQdWJDb3VudCA9IC0xOw0KICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBwcmV2UHViSUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgcHJldlB1YkNvdW50ID0gSW50ZWdlci5wYXJzZUludChyb3cuZ2V0VmFsdWUoInByZXZwdWJjb3VudCIpKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKHByZXZQdWJDb3VudCA+IDApew0KICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIk1vZHVsZSBhbHJlYWR5IHB1Ymxpc2hlZDoiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2F0Y2ggKE51bWJlckZvcm1hdEV4Y2VwdGlvbiBlKXsNCiAgICAgICAgICAgICAgICBpY3MuU2V0T2JqKCJoYXNFcnJvciIsICJ0cnVlIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChOb1N1Y2hGaWVsZEV4Y2VwdGlvbiBlKXsNCiAgICAgICAgICAgICAgICBpY3MuU2V0T2JqKCJoYXNFcnJvciIsICJ0cnVlIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpLCBlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyBjb21tZW50ZWQgYnkgTG9rZXNoIDkvMjEvMjAxMCBhcyBwZXIgRG9sZidzIGZlZWRiYWNrDQogICAgICAgIC8qaWYobnVsbCAhPSBwcmV2UHViSUxpc3Qpew0KICAgICAgICAgICAgcHJldlB1YklMaXN0LmZsdXNoKCk7DQogICAgICAgIH0qLw0KICAgICAgICBzcWxTdG0gPSAiU0VMRUNUIGNvdW50KCopIGFzIGFwcHJvdmVkYXNzZXRjb3VudCBGUk9NIEFwcHJvdmVkQXNzZXRzIFdIRVJFIGFzc2V0aWQ9JyIgKyBpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSArICInIiArICIgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIEFORCB0c3RhdGU9J0EnIjsNCiAgICAgICAgdGFibGVOYW1lcyA9ICJBcHByb3ZlZEFzc2V0cyI7DQogICAgICAgIElMaXN0IGFwcHJvdmVkQXNzZXRJTGlzdCA9IHJ1blNRTChzcWxTdG0sIHRhYmxlTmFtZXMsIGljcyk7DQogICAgICAgIGlmKG51bGwgIT0gYXBwcm92ZWRBc3NldElMaXN0JiYgYXBwcm92ZWRBc3NldElMaXN0Lmhhc0RhdGEoKSl7DQogICAgICAgICAgICB0cnl7DQogICAgICAgICAgICAgICAgaW50IGFwcHJvdmVkQXNzZXRDb3VudCA9IC0xOw0KICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBhcHByb3ZlZEFzc2V0SUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgYXBwcm92ZWRBc3NldENvdW50ID0gSW50ZWdlci5wYXJzZUludChyb3cuZ2V0VmFsdWUoImFwcHJvdmVkYXNzZXRjb3VudCIpKTsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmKGFwcHJvdmVkQXNzZXRDb3VudCA8IDEpew0KICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIk1vZHVsZSBpcyBpbiBoZWxkIHN0YXRlIGFuZCB3b24ndCBiZSBwdWJsaXNoZWQ6IiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChOdW1iZXJGb3JtYXRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSwgZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoTm9TdWNoRmllbGRFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSwgZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy9jb21tZW50ZWQgYnkgTG9rZXNoIG9uIDkvMjEvMjAxMA0KICAgICAgICAvKmlmKG51bGwgIT0gcHJldlB1YklMaXN0KXsNCiAgICAgICAgICAgIHByZXZQdWJJTGlzdC5mbHVzaCgpOw0KICAgICAgICB9Ki8NCiAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCi8vcmVhZCB0aGUgcmVuZGVyZWQgcGFnZSBjb250ZW50IGludG8gYSBzdHJpbmcuDQoNCi8vICAgICAgICBsb2cuZGVidWcoIkNvbnRleHQgaXM6ICIgKyBpY3MuR2V0VmFyKCJjb250ZXh0IikpOw0KICAgICAgICBTdHJpbmcgdGhlUGFnZSA9IGljcy5SZWFkUGFnZSAoIGljcy5HZXRWYXIoInNpdGUiKSArICIvR1VfTW9kdWxlX0MvIiArIFN0cmluZ1V0aWxzLnN0cmlwKHRlbXBsYXRlX25hbWUsIi8iKSwgYXJncyk7DQogICAgICAgIGFyZ3MucmVtb3ZlQWxsKCk7DQogICAgICAgIGlmICggdGhlUGFnZSA9PSBudWxsICkgIHsNCiAgICAgICAgICAgIGludCBlcnJubyA9IGljcy5HZXRFcnJubygpOw0KICAgICAgICAgICAgaWYoZXJybm8gIT0gMCl7DQogICAgICAgICAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciAoZXJybm8iICsgZXJybm8gKyAiKSB3aGlsZSByZWFkaW5nIHdyYXBwZXIgd2l0aCBtb2R1bGUgdXJsPSIgKyBpY3MuR2V0VmFyKCJsaW5rdXJsIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgIHsNCiAgICAgICAgICAgIGdldFBhdGhQcmVmaXgoaWNzKTsNCiAgICAgICAgICAgIGxvZy5kZWJ1ZygiUHVibGlzaGluZyBTU0kgTW9kdWxlOiAiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgU2Vzc2lvbiBzZXMgPSBTZXNzaW9uRmFjdG9yeS5nZXRTZXNzaW9uKGljcyk7DQogICAgICAgICAgICBBc3NldERhdGFNYW5hZ2VyIG1nciA9IChBc3NldERhdGFNYW5hZ2VyKSBzZXMuZ2V0TWFuYWdlcihBc3NldERhdGFNYW5hZ2VyLmNsYXNzLmdldE5hbWUoKSApOw0KICAgICAgICAgICAgdHJ5ew0KICAgICAgICAgICAgICAgIElMaXN0IHN0YXRpY1BhZ2VsZXRJTGlzdCA9IG51bGw7DQogICAgICAgICAgICAgICAgc3FsU3RtID0gIlNFTEVDVCBpZCxyZXF1ZXN0IEZST00gc3RhdGljX3BhZ2VsZXQgV0hFUkUgb3duZXJpZD0nIiArIChTdHJpbmcpaWNzLkdldE9iaigic3RhdGljUGFnZWxldElEIikgKyAiJyBBTkQgYXNzZXRpZD0nIiArIGljcy5HZXRWYXIoIm1vZHVsZV9pZCIpICsgIicgQU5EIHRhcmdldGlkPSciICsgaWNzLkdldFZhcigidGFyZ2V0SUQiKSArICInIjsNCiAgICAgICAgICAgICAgICB0YWJsZU5hbWVzID0gInN0YXRpY19wYWdlbGV0IjsNCiAgICAgICAgICAgICAgICBzdGF0aWNQYWdlbGV0SUxpc3QgPSBydW5TUUwoc3FsU3RtLCB0YWJsZU5hbWVzLCBpY3MpOw0KDQogICAgICAgICAgICAgICAgaWYoaWNzLkdldEVycm5vKCkgIT0gLTEwMSAmJiBzdGF0aWNQYWdlbGV0SUxpc3QgIT0gbnVsbCAmJiBzdGF0aWNQYWdlbGV0SUxpc3QubnVtUm93cygpID4gMCl7DQogICAgICAgICAgICAgICAgICAgIGZvciAoSUxpc3Qgcm93IDogbmV3IEl0ZXJhYmxlSUxpc3RXcmFwcGVyKCBzdGF0aWNQYWdlbGV0SUxpc3QpKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZyBmaWxlUGF0aCA9IHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAocm93LmdldFZhbHVlKCJyZXF1ZXN0IiksIi8iKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vZGVsZXRlIHRoZSBvbGQgZmlsZXBhdGggZmlyc3QNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygiRGVsZXRpbmc6ICIgKyBmaWxlUGF0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICBib29sZWFuIGlzRGVsZXRlZCA9IGRlbGV0ZUZpbGUoaWNzLCBmaWxlUGF0aCk7DQogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIG1vZHVsZSBjb3VsZG4ndCBiZSBzdWNjZXNzZnVsbHkgZGVsZXRlZCwgdGhlIG1vZHVsZSB3b24ndCBiZSB1cGRhdGVkDQogICAgICAgICAgICAgICAgICAgICAgICBpZighaXNEZWxldGVkKXsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3NldHRpbmcgdGhlIGxpbmt1cmwgZm9yIHNzaSBiYWNrIHRvIHRoZSBvbGQgbW9kdWxlIHRoYXQgd2FzIHB1Ymxpc2hlZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljcy5TZXRWYXIoImxpbmt1cmwiLCByb3cuZ2V0VmFsdWUoInJlcXVlc3QiKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKGZpbGVQYXRoICsgIiBjb3VsZCBub3QgYmUgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQuIE1vZHVsZToiICsgaWNzLkdldFZhcigibW9kdWxlX2lkIikgKyAiIHdvbid0IGJlIHVwZGF0ZWQiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vb2xkIG1vZHVsZSB3YXMgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQsIGhlbmNlIHB1Ymxpc2hpbmcgbmV3IG1vZHVsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQXR0ZW1wdGluZyB0byB3cml0ZSBhbiB1cGRhdGVkIG1vZHVsZSB0byAiICsgcGF0aFByZWZpeCtTdHJpbmdVdGlscy5zdHJpcChpY3MuR2V0VmFyKCJsaW5rdXJsIiksIi8iKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsZVV0aWxzLndyaXRlU3RyaW5nVG9GaWxlKG5ldyBGaWxlKHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAoaWNzLkdldFZhcigibGlua3VybCIpLCIvIikpLCB0aGVQYWdlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVyYWJsZTxBc3NldERhdGE+IGFzc2V0cyA9IG1nci5yZWFkKCBBcnJheXMuPEFzc2V0SWQ+YXNMaXN0KCBuZXcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFzc2V0SWRJbXBsKCAic3RhdGljX3BhZ2VsZXQiLCBMb25nLnBhcnNlTG9uZyhyb3cuZ2V0VmFsdWUoImlkIikpICkpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaXN0PEFzc2V0RGF0YT4gc0Fzc2V0cyA9IG5ldyBBcnJheUxpc3Q8QXNzZXREYXRhPigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIEFzc2V0RGF0YSBhIDogYXNzZXRzICkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNBc3NldHMuYWRkKCBhICk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsodGVtcGxhdGVBcmdzKSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoInRlbXBsYXRlX2FyZ3MiKS5zZXREYXRhKHRlbXBsYXRlQXJncyk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoYW5naW5nLCBpY3MuR2V0U1NWYXIoInB1YnNlc3M6aWQiKSB0byAoU3RyaW5nKWljcy5HZXRPYmooInB1YnNlc3M6aWQiKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuY29udGFpbnMoaWNzLkdldFZhcigibGlua3VybCIpLCAiXyIpICYmIFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuZ2V0QXR0cmlidXRlRGF0YSgib3duZXJpZCIpLnNldERhdGEoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuZ2V0QXR0cmlidXRlRGF0YSgib3duZXJpZCIpLnNldERhdGEoIiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5nZXRBdHRyaWJ1dGVEYXRhKCJwdWJzZXNzaW9uaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoICJ0ZW1wbGF0ZSIgKS5zZXREYXRhKFN0cmluZ1V0aWxzLnN0cmlwKHRlbXBsYXRlX25hbWUsICIvIikpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmdldEF0dHJpYnV0ZURhdGEoICJyZXF1ZXN0IiApLnNldERhdGEoIGljcy5HZXRWYXIoImxpbmt1cmwiKSApOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZ3IudXBkYXRlKCBzQXNzZXRzICk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZXsNCiAgICAgICAgICAgICAgICAgICAgaWNzLkNsZWFyRXJybm8oKTsNCiAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBdHRlbXB0aW5nIHRvIHdyaXRlIHRoZSBuZXcgbW9kdWxlIHRvICIgKyBwYXRoUHJlZml4K1N0cmluZ1V0aWxzLnN0cmlwKGljcy5HZXRWYXIoImxpbmt1cmwiKSwiLyIpKTsNCiAgICAgICAgICAgICAgICAgICAgRmlsZVV0aWxzLndyaXRlU3RyaW5nVG9GaWxlKG5ldyBGaWxlKHBhdGhQcmVmaXgrU3RyaW5nVXRpbHMuc3RyaXAoaWNzLkdldFZhcigibGlua3VybCIpLCIvIikpLCB0aGVQYWdlKTsNCg0KICAgICAgICAgICAgICAgICAgICBNdXRhYmxlQXNzZXREYXRhIGFzc2V0RGF0YSA9IG1nci5uZXdBc3NldERhdGEoInN0YXRpY19wYWdlbGV0IiwiIik7DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJuYW1lIikuc2V0RGF0YShpY3MuR2V0VmFyKCJtb2R1bGVfaWQiKSk7DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJyZXF1ZXN0Iikuc2V0RGF0YShpY3MuR2V0VmFyKCJsaW5rdXJsIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgiYXNzZXRpZCIpLnNldERhdGEoaWNzLkdldFZhcigibW9kdWxlX2lkIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgiYXNzZXR0eXBlIikuc2V0RGF0YSgiR1VfTW9kdWxlX0MiKTsNCiAgICAgICAgICAgICAgICAgICAgaWYoU3RyaW5nVXRpbHMuY29udGFpbnMoaWNzLkdldFZhcigibGlua3VybCIpLCAiXyIpICYmIFN0cmluZ1V0aWxzLmlzTm90QmxhbmsoKFN0cmluZylpY3MuR2V0T2JqKCJzdGF0aWNQYWdlbGV0SUQiKSkpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXREYXRhLmdldEF0dHJpYnV0ZURhdGEoIm93bmVyaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigic3RhdGljUGFnZWxldElEIikpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJ0ZW1wbGF0ZSIpLnNldERhdGEoU3RyaW5nVXRpbHMuc3RyaXAodGVtcGxhdGVfbmFtZSwgIi8iKSk7DQogICAgICAgICAgICAgICAgICAgIGlmKFN0cmluZ1V0aWxzLmlzTm90QmxhbmsodGVtcGxhdGVBcmdzKSl7DQogICAgICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgidGVtcGxhdGVfYXJncyIpLnNldERhdGEodGVtcGxhdGVBcmdzKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSgidGFyZ2V0aWQiKS5zZXREYXRhKGljcy5HZXRWYXIoInRhcmdldElEIikpOw0KICAgICAgICAgICAgICAgICAgICBhc3NldERhdGEuZ2V0QXR0cmlidXRlRGF0YSggIlB1Ymxpc3QiICkuc2V0RGF0YSggQXJyYXlzLmFzTGlzdChpY3MuR2V0VmFyKCJzaXRlIikgKSApOw0KICAgICAgICAgICAgICAgICAgICAvLyBNb2RpZmllZDogcmdpbGwsIDIwMTAtMDktMTcNCiAgICAgICAgICAgICAgICAgICAgLy8gY2hhbmdpbmcsIGljcy5HZXRTU1ZhcigicHVic2VzczppZCIpIHRvIChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpDQogICAgICAgICAgICAgICAgICAgIGFzc2V0RGF0YS5nZXRBdHRyaWJ1dGVEYXRhKCJwdWJzZXNzaW9uaWQiKS5zZXREYXRhKChTdHJpbmcpaWNzLkdldE9iaigicHVic2VzczppZCIpKTsNCg0KICAgICAgICAgICAgICAgICAgICBtZ3IuaW5zZXJ0KEFycmF5cy48QXNzZXREYXRhPmFzTGlzdChhc3NldERhdGEpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoTnVtYmVyRm9ybWF0RXhjZXB0aW9uIGUpew0KICAgICAgICAgICAgICAgIGljcy5TZXRPYmooImhhc0Vycm9yIiwgInRydWUiKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoIkVycm9yIG9jY3VycmVkIGluIGNvbnZlcnRpbmcgc3RhdGljX3BhZ2VsZXQgaWQgdG8gTG9uZyIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldE1lc3NhZ2UoKSk7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0U3RhY2tUcmFjZSgpLnRvU3RyaW5nKCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2F0Y2ggKE5vU3VjaEZpZWxkRXhjZXB0aW9uIGUpew0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3Igb2NjdXJyZWQgaW4gcmV0cmlldmluZyBpZCBvciByZXF1ZXN0IGZyb20gbW9kdWxlZGlwYXRjaGVyIik7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRTdGFja1RyYWNlKCkudG9TdHJpbmcoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoSU9FeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgd3JpdGluZyB0byAiICsgcGF0aFByZWZpeCtTdHJpbmdVdGlscy5zdHJpcChpY3MuR2V0VmFyKCJsaW5rdXJsIiksIi8iKSk7DQogICAgICAgICAgICAgICAgbG9nLmVycm9yKGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRTdGFja1RyYWNlKCkudG9TdHJpbmcoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoQXNzZXRBY2Nlc3NFeGNlcHRpb24gZSl7DQogICAgICAgICAgICAgICAgaWNzLlNldE9iaigiaGFzRXJyb3IiLCAidHJ1ZSIpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcigiRXJyb3Igb2NjdXJyZWQgaW4gdXBkYXRpbmcgc3RhdGljX3BhZ2VsZXQiKTsNCiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICAgIGxvZy5lcnJvcihlLmdldFN0YWNrVHJhY2UoKS50b1N0cmluZygpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiU+PC9jczpmdGNzPg==";
                    
        
        byte[] o = x.getBytes("UTF-8");
        System.out.println(o.length);
        long len = (o.length * 3) / 4;
        System.out.println(len);
        System.out.println(x.length());
        
        byte[] b = Base64.decode(x);
        System.out.println(b.length);
        System.out.println(new String(b,b.length-500,500));
        
        String y = Base64.encode(b);
        System.out.println(y.length());
        assertEquals(x,y);
        
        
    }
    public void testEncode() throws IOException {
        byte[] b = FileUtils.readFileToByteArray(new File("/data/code/java/rest/fw-rest-sample/src/test/resources/base64-test.bin"));
        String y = Base64.encode(b);
        int t=y.indexOf("==");
        System.out.println(y);
        if (t > 0 && t< y.length()-20){
            
            System.out.println(y.substring(t-20,40));
        }
        
        assertEquals(x,y);
    }
}
